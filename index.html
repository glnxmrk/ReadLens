<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReadLens - Focused Literacy. Clear Results </title>

    <!-- PWA Manifest & Icons -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="theme-color" content="#3498db">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Google Fonts: Montserrat -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400&display=swap"
        rel="stylesheet">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2c3e50;
            --accent: #e74c3c;
            --success: #2ecc71;
            --warning: #f39c12;
            --info: #8e44ad;
            --light: #f8f9fa;
            --dark: #212529;
            --border-radius: 12px;
            --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);

            /* Font Size Variables */
            --letter-fs: 2.5rem;
            --sentence-fs: 2rem;
            --rhyme-fs: 1.2rem;
            --story-fs: 1.5rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            color: var(--dark);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        /* --- AUTHENTICATION STYLES START --- */
        #authWrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 90vh;
            width: 100%;
            text-align: center;
            color: white;
            animation: fadeIn 0.5s ease;
        }

        .auth-card {
            background: white;
            padding: 0;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 450px;
            color: var(--secondary);
            margin-bottom: 30px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .auth-header-bg {
            background: linear-gradient(to bottom right, #3498db, #2c3e50);
            padding: 40px 20px 30px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: white;
            position: relative;
        }

        .auth-logo-circle {
            background: white;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .auth-card-body {
            padding: 30px 40px 40px 40px;
        }

        .auth-logo {
            display: flex;
            justify-content: center;
        }

        .auth-app-name {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 5px;
            line-height: 1;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .auth-tagline {
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 5px;
            font-size: 0.95rem;
        }

        .auth-credits-internal {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin: 0 0 25px 0;
            font-style: normal;
            line-height: 1.4;
            padding: 0 10px;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .auth-input {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Montserrat', sans-serif;
            transition: border-color 0.3s;
        }

        .auth-input:focus {
            border-color: var(--primary);
            outline: none;
        }

        .auth-btn {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            font-family: 'Montserrat', sans-serif;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 10px;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .auth-switch {
            margin-top: 15px;
            font-size: 0.9rem;
            color: #666;
        }

        .auth-switch a {
            color: var(--primary);
            text-decoration: none;
            font-weight: bold;
            cursor: pointer;
        }

        .hidden {
            display: none !important;
        }

        /* --- AUTHENTICATION STYLES END --- */

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            background: linear-gradient(to right, #3498db, #2c3e50);
            padding: 20px 30px;
            margin-bottom: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo-icon {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-book {
            width: 70px;
            height: 55px;
            background: linear-gradient(to right, #3498db, #2c3e50);
            border-radius: 6px 15px 15px 6px;
            position: relative;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .logo-book:before {
            content: '';
            position: absolute;
            width: 12px;
            height: 55px;
            background: linear-gradient(to right, #2980b9, #2c3e50);
            border-radius: 0 6px 6px 0;
            right: -12px;
            top: 0;
        }

        .logo-book-pages {
            position: absolute;
            width: 55px;
            height: 48px;
            background-color: white;
            left: 7px;
            top: 3.5px;
            border-radius: 3px;
            overflow: hidden;
        }

        .logo-page-line {
            position: absolute;
            width: 48px;
            height: 1px;
            background-color: #e0e0e0;
            left: 3.5px;
        }

        .logo-page-line:nth-child(1) {
            top: 7px;
        }

        .logo-page-line:nth-child(2) {
            top: 11px;
        }

        .logo-page-line:nth-child(3) {
            top: 15px;
        }

        .logo-page-line:nth-child(4) {
            top: 19px;
        }

        .logo-page-line:nth-child(5) {
            top: 23px;
        }

        .logo-page-line:nth-child(6) {
            top: 27px;
        }

        .logo-page-line:nth-child(7) {
            top: 31px;
        }

        .logo-page-line:nth-child(8) {
            top: 35px;
        }

        .logo-magnifying-glass {
            position: absolute;
            width: 25px;
            height: 25px;
            border: 3px solid #e74c3c;
            border-radius: 50%;
            right: -8px;
            top: 15px;
            z-index: 10;
        }

        .logo-magnifying-glass:after {
            content: '';
            position: absolute;
            width: 12px;
            height: 3px;
            background-color: #e74c3c;
            transform: rotate(45deg);
            bottom: -8px;
            right: -6px;
        }

        .logo-text {
            text-align: left;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .logo-name {
            font-size: 48px;
            font-weight: 700;
            color: white;
            margin-bottom: 5px;
            letter-spacing: 1px;
            line-height: 1;
        }

        .logo-tagline {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 400;
            line-height: 1.2;
        }

        .header-school-info {
            color: white;
            text-align: right;
            display: flex;
            flex-direction: column;
            justify-content: center;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: background-color 0.2s;
            min-width: 200px;
        }

        .header-school-info:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .header-info-line {
            font-size: 1rem;
            line-height: 1.4;
            font-weight: 400;
        }

        .header-info-line strong {
            font-weight: 600;
            font-size: 1.1rem;
            display: block;
            margin-bottom: 2px;
        }

        .assessment-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .tasks-panel {
            flex: 0 0 240px;
            /* Reduced width fixed to 240px */
            min-width: 240px;
        }

        .assessment-panel {
            flex: 1;
            /* Grow to fill remaining space */
            min-width: 500px;
        }

        .card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-title {
            font-size: 1.4rem;
            margin-bottom: 15px;
            color: var(--secondary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .task-list {
            list-style-type: none;
        }

        .task-item {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: var(--border-radius);
            background-color: white;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .task-item:hover {
            transform: translateX(5px);
            border-color: var(--primary);
            background-color: #f8f9fa;
        }

        .task-item.active {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            border-color: transparent;
            box-shadow: 0 5px 15px rgba(44, 62, 80, 0.2);
            transform: scale(1.02);
        }

        .task-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background-color: #e9ecef;
            color: var(--secondary);
            border-radius: 50%;
            margin-right: 15px;
            font-weight: 700;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .task-item:hover .task-number {
            background-color: var(--primary);
            color: white;
        }

        .task-item.active .task-number {
            background-color: rgba(255, 255, 255, 0.25);
            color: white;
            backdrop-filter: blur(5px);
        }

        .task-content {
            display: none;
            margin-top: 20px;
        }

        .task-content.active {
            display: block;
        }

        .assessment-item {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
        }

        .assessment-text {
            font-size: 1.2rem;
            margin-bottom: 15px;
        }

        .score-input {
            width: 80px;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 1rem;
            font-family: 'Montserrat', sans-serif;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
            position: relative;
            z-index: 10;
        }

        .slider-control {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: #fff;
            padding: 5px 15px;
            border-radius: 20px;
            border: 1px solid #ced4da;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .slider-control input[type=range] {
            width: 100px;
            cursor: pointer;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            pointer-events: auto;
            /* Ensure clickable */
        }

        .btn-primary {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
        }

        .btn-secondary {
            background-color: #e9ecef;
            color: var(--dark);
        }

        .btn-success {
            background: linear-gradient(to right, var(--success), #27ae60);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(to right, var(--warning), #e67e22);
            color: white;
        }

        .btn-info {
            background: linear-gradient(to right, var(--info), #9b59b6);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(to right, var(--accent), #c0392b);
            color: white;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .results-panel {
            margin-top: 30px;
        }

        .profile-card {
            background: linear-gradient(to right, #f8f9fa, #e9ecef);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 20px;
            border-left: 5px solid var(--primary);
        }

        .profile-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: var(--secondary);
        }

        .profile-description {
            margin-bottom: 15px;
        }

        .profile-evidence {
            background-color: white;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 15px;
        }

        .language-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }

        .letters-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .letter-card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
        }

        .letter-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .letter {
            font-family: 'Comic Sans MS', 'Comic Sans', cursive;
            /* Student readability */
            font-size: var(--letter-fs);
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--secondary);
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
            word-break: break-word;
            /* Ensure words/sentences wrap */
        }

        .letter:hover {
            background-color: #f0f0f0;
        }

        .letter-status {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .status-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.2s ease;
        }

        .status-btn:hover {
            transform: scale(1.1);
        }

        .correct-btn {
            background-color: var(--success);
            color: white;
        }

        .incorrect-btn {
            background-color: var(--accent);
            color: white;
        }

        .letter-card.correct {
            border-color: var(--success);
            background-color: rgba(46, 204, 113, 0.1);
            animation: correctPulse 0.5s ease;
        }

        .letter-card.incorrect {
            border-color: var(--accent);
            background-color: rgba(231, 76, 60, 0.1);
        }

        /* New Styles for Sentence Mode in Task 1 */
        .letter-sentence {
            font-size: var(--letter-fs);
            line-height: 1.4;
            text-align: center;
            margin-bottom: 10px;
            font-family: 'Comic Sans MS', cursive;
        }

        .t1-word {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 4px;
            display: inline-block;
        }

        .t1-word:hover {
            background-color: #f0f0f0;
        }

        .t1-word.miscue {
            color: var(--accent);
            text-decoration: line-through;
            background-color: rgba(231, 76, 60, 0.1);
        }

        @keyframes correctPulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        .score-display {
            font-size: 1.2rem;
            font-weight: bold;
            margin: 20px 0;
            padding: 15px;
            background-color: #e6f0ff;
            border-radius: var(--border-radius);
            text-align: center;
        }

        /* NEW STYLES FOR ENROLLMENT */
        .enrollment-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .enrollment-form {
            flex: 1;
            min-width: 300px;
        }

        .enrolled-learners {
            flex: 1;
            min-width: 300px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 1rem;
            font-family: 'Montserrat', sans-serif;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .learners-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: var(--border-radius);
        }

        .learner-item {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .learner-item:hover {
            background-color: #f8f9fa;
        }

        .learner-item.active {
            background-color: #e6f0ff;
            border-left: 4px solid var(--primary);
        }

        .learner-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .learner-details {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .no-learners {
            padding: 20px;
            text-align: center;
            color: #6c757d;
            font-style: italic;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            pointer-events: none;
            /* Critical fix to prevent blocking when hidden */
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            background: linear-gradient(to right, #3498db, #2c3e50);
            padding: 20px;
            color: white;
        }

        .modal-title {
            margin: 0;
            font-size: 1.5rem;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            background-color: #f8f9fa;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Sentence Reading Styles (UPDATED) */
        .sentence-display {
            font-family: 'Comic Sans MS', 'Comic Sans', cursive;
            /* Student readability */
            font-size: var(--sentence-fs);
            line-height: 2;
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background-color: white;
            border: 1px solid #eee;
            border-radius: 12px;
        }

        .sentence-word {
            cursor: pointer;
            padding: 2px 5px;
            border-radius: 4px;
            transition: all 0.2s;
            display: inline-block;
        }

        .sentence-word:hover {
            background-color: #f0f0f0;
        }

        .sentence-word.miscue {
            color: var(--accent);
            text-decoration: line-through;
            background-color: rgba(231, 76, 60, 0.1);
        }

        .edit-area-container {
            display: none;
            margin-bottom: 20px;
            background: #fff9db;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #ffe066;
        }

        .edit-textarea {
            width: 100%;
            border: 1px solid #ced4da;
            border-radius: 8px;
            padding: 15px;
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        /* Rhyming Task Styles */
        .rhyme-list-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .rhyme-item {
            display: flex;
            align-items: center;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            justify-content: space-between;
        }

        .rhyme-text {
            font-family: 'Comic Sans MS', 'Comic Sans', cursive;
            /* Student readability */
            font-size: var(--rhyme-fs);
            font-weight: 600;
            flex: 1;
            cursor: pointer;
            padding: 5px;
            border-bottom: 1px dashed transparent;
        }

        .rhyme-text:hover {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }

        .rhyme-actions {
            display: flex;
            gap: 10px;
        }

        /* Story Reading Styles (UPDATED) */
        .story-display {
            font-family: 'Comic Sans MS', 'Comic Sans', cursive;
            /* Student readability */
            font-size: var(--story-fs);
            line-height: 1.8;
            padding: 25px;
            background-color: white;
            border: 1px solid #eee;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: justify;
            word-spacing: 8px;
            /* Increased spacing between words */
        }

        .story-word {
            cursor: pointer;
            padding: 0 2px;
            border-radius: 3px;
            transition: all 0.2s;
            margin-right: 8px;
            /* Added margin for better word spacing */
            display: inline-block;
        }

        .story-word:hover {
            background-color: #f0f0f0;
        }

        .story-word.miscue {
            color: var(--accent);
            text-decoration: line-through;
            background-color: rgba(231, 76, 60, 0.1);
        }

        .timer-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
        }

        .timer-display {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--secondary);
            font-variant-numeric: tabular-nums;
        }

        .comprehension-section {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            margin-top: 20px;
        }

        .question-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
        }

        .question-item:last-child {
            border-bottom: none;
        }

        .question-text {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .answer-key {
            font-size: 0.95rem;
            color: #666;
            margin-bottom: 10px;
            font-style: italic;
        }

        .passage-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 20px;
        }

        .passage-select {
            flex: 1;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ced4da;
            font-family: 'Montserrat', sans-serif;
        }

        /* MOOD SCALE STYLES */
        .mood-scale {
            margin: 20px 0;
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .mood-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 15px;
        }

        .mood-container {
            display: flex;
            flex-direction: row;
            /* Horizontal */
            justify-content: space-between;
            gap: 10px;
        }

        .mood-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            /* Stack Number and Emoji vertically */
            align-items: center;
            justify-content: center;
            padding: 15px 5px;
            border-top: 5px solid #ddd;
            /* Move thick border to top */
            border-left: 1px solid #eee;
            border-right: 1px solid #eee;
            border-bottom: 1px solid #eee;
            background-color: #fafafa;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .mood-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .mood-item.selected {
            transform: scale(1.05);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
            background-color: #fff;
        }

        .mood-number {
            font-weight: bold;
            font-size: 1.5em;
            color: #555;
            margin-bottom: 5px;
        }

        .mood-emoji {
            font-size: 2.5em;
            margin: 0;
            line-height: 1;
        }

        .mood-item[data-mood="1"] {
            border-top-color: #e74c3c;
            background-color: #fff5f5;
        }

        .mood-item[data-mood="2"] {
            border-top-color: #e67e22;
            background-color: #fffaf5;
        }

        .mood-item[data-mood="3"] {
            border-top-color: #f1c40f;
            background-color: #fffff5;
        }

        .mood-item[data-mood="4"] {
            border-top-color: #2ecc71;
            background-color: #f5fff5;
        }

        .mood-item[data-mood="5"] {
            border-top-color: #27ae60;
            background-color: #f0fff0;
        }

        .mood-item.selected[data-mood="1"] {
            background-color: #ffeaea;
        }

        .mood-item.selected[data-mood="2"] {
            background-color: #fff0e5;
        }

        .mood-item.selected[data-mood="3"] {
            background-color: #fffce5;
        }

        .mood-item.selected[data-mood="4"] {
            background-color: #eaffea;
        }

        .mood-item.selected[data-mood="5"] {
            background-color: #e0ffe0;
        }

        /* Observation Levels */
        .observation-panel {
            margin: 20px 0;
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid #dee2e6;
        }

        .observation-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 15px;
        }

        .observation-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .observation-option {
            border: 1px solid #ced4da;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            background-color: white;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .observation-option:hover {
            border-color: var(--primary);
            background-color: #f0f8ff;
        }

        .observation-option.selected {
            background-color: #e6f0ff;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .level-label {
            font-weight: 700;
            font-size: 1rem;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .level-desc {
            font-size: 0.85rem;
            color: #555;
            line-height: 1.2;
        }

        /* NEW STYLES FOR DATA & REPORTS */
        .reports-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .reports-inputs-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            /* Increased margin as requested */
            width: 100%;
        }

        .reports-buttons-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            width: 100%;
            position: relative;
            z-index: 10;
        }

        /* Report Tabs Style */
        .report-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .report-tab {
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            border: 1px solid transparent;
            border-bottom: none;
            margin-bottom: -2px;
        }

        .report-tab:hover {
            color: var(--primary);
            background-color: #f8f9fa;
        }

        .report-tab.active {
            color: var(--primary);
            background-color: white;
            border-color: #eee;
            border-bottom: 2px solid var(--primary);
        }

        .report-card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            margin-bottom: 20px;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .report-title {
            font-size: 1.3rem;
            color: var(--secondary);
        }

        .assessment-history {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .assessment-history th,
        .assessment-history td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .assessment-history th {
            background-color: #2c3e50;
            /* Dark Blue Header as requested */
            color: white;
            font-weight: 600;
        }

        .assessment-history tr:hover {
            background-color: #f8f9fa;
        }

        .report-details-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .report-details-table td {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .report-details-header {
            background-color: #f0f4f8;
            font-weight: bold;
        }

        .confetti-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
            overflow: hidden;
            border-radius: var(--border-radius);
        }

        .confetti-piece {
            position: absolute;
            width: 8px;
            height: 16px;
            opacity: 0;
            animation: confettiExplode 1.5s ease-out forwards;
        }

        @keyframes confettiExplode {
            0% {
                transform: translate(0, 0) rotate(0deg);
                opacity: 1;
            }

            100% {
                transform: translate(var(--tx), var(--ty)) rotate(var(--r));
                opacity: 0;
            }
        }

        .sad-face {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 120px;
            z-index: 1000;
            animation: fadeInOut 2s forwards;
            pointer-events: none;
        }

        @keyframes fadeInOut {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }

            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }

            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        footer {
            text-align: center;
            margin-top: 40px;
            color: white;
            opacity: 0.8;
        }

        /* --- DASHBOARD STYLES --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 10px;
        }

        .stat-panel {
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .stat-panel::before {
            content: '';
            position: absolute;
            top: -20px;
            right: -20px;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
        }

        .panel-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .bar-chart-container {
            /* Now handled by vertical-chart style, but keeping for compatibility if needed */
        }

        /* --- REDESIGNED VERTICAL CHART STYLES (MODIFIED) --- */
        .vertical-chart {
            display: flex;
            align-items: flex-end;
            height: 400px;
            /* INCREASED from 250px */
            padding: 30px 10px 50px 10px;
            width: 100%;
            gap: 10px;
            box-sizing: border-box;
        }

        .v-category {
            flex: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            position: relative;
        }

        .v-bars-group {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 4px;
            height: 100%;
            width: 100%;
        }

        .v-bar {
            width: 45%;
            /* INCREASED from 35% */
            max-width: 80px;
            /* INCREASED from 40px */
            min-width: 15px;
            border-radius: 4px 4px 0 0;
            position: relative;
            transition: height 1s cubic-bezier(0.19, 1, 0.22, 1);
            min-height: 4px;
            /* Visibility for 0 */
        }

        .v-bar-value {
            position: absolute;
            top: -25px;
            /* Adjusted spacing */
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.9rem;
            /* INCREASED from 0.75rem */
            color: rgba(255, 255, 255, 0.9);
            font-weight: 600;
            white-space: nowrap;
        }

        .v-label {
            position: absolute;
            bottom: -45px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 0.75rem;
            line-height: 1.2;
            color: rgba(255, 255, 255, 0.9);
            height: 40px;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            overflow: hidden;
        }

        .bar-male {
            background-color: #5dade2;
        }

        .bar-female {
            background-color: #ff85a2;
        }

        /* Legend */
        .chart-legend {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            font-size: 0.8rem;
            justify-content: flex-end;
            opacity: 0.8;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-box {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .dashboard-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            margin-bottom: 20px;
        }
    </style>
    <link rel="stylesheet" href="/index.css">
</head>

<body>

    <!-- AUTHENTICATION CONTAINER -->
    <div id="authWrapper">
        <div class="auth-card">
            <div class="auth-header-bg">
                <div class="auth-logo">
                    <div class="auth-logo-circle">
                        <div class="logo-icon" style="transform: scale(1.5);">
                            <div class="logo-book">
                                <div class="logo-book-pages">
                                    <div class="logo-page-line"></div>
                                    <div class="logo-page-line"></div>
                                    <div class="logo-page-line"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="auth-app-name">ReadLens</div>
                <div class="auth-tagline">Focused Literacy. Clear Results</div>
            </div>

            <div class="auth-card-body">
                <div class="auth-credits-internal">
                    This Assessment Tool was made possible through the efforts of<br>
                    Rosavelia O. Jimenez and Glenn Mark S. Presores<br>
                    of San Jose Integrated School, Quezon I District, Division of Bukidnon.
                </div>

                <div id="loginFormSection">
                    <div class="auth-form">
                        <input type="text" id="loginUsername" class="auth-input"
                            placeholder="Teacher's Name / Username">
                        <input type="password" id="loginPassword" class="auth-input" placeholder="Password">
                        <button id="btnLogin" class="auth-btn">Log In</button>
                    </div>
                    <div class="auth-switch">
                        First time user? <a id="showRegister">Create an Account</a>
                    </div>
                </div>

                <div id="registerFormSection" class="hidden">
                    <div class="auth-form">
                        <input type="text" id="regName" class="auth-input" placeholder="Full Name (Teacher)">
                        <input type="text" id="regSchool" class="auth-input" placeholder="School Name">
                        <input type="text" id="regGrade" class="auth-input" placeholder="Grade & Section">
                        <input type="password" id="regPassword" class="auth-input" placeholder="Create Password">
                        <input type="password" id="regSecretCode" class="auth-input" placeholder="Secret Code">
                        <button id="btnRegister" class="auth-btn">Create Account</button>
                    </div>
                    <div class="auth-switch">
                        Already have an account? <a id="showLogin">Log In</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP CONTAINER (Hidden until login) -->
    <div id="appWrapper" class="hidden">
        <div class="container">
            <header>
                <div class="logo-container">
                    <div class="logo-icon">
                        <div class="logo-book">
                            <div class="logo-book-pages">
                                <div class="logo-page-line"></div>
                                <div class="logo-page-line"></div>
                                <div class="logo-page-line"></div>
                                <div class="logo-page-line"></div>
                                <div class="logo-page-line"></div>
                                <div class="logo-page-line"></div>
                                <div class="logo-page-line"></div>
                                <div class="logo-page-line"></div>
                            </div>
                        </div>
                        <div class="logo-magnifying-glass"></div>
                    </div>
                    <div class="logo-text">
                        <h1 class="logo-name">ReadLens</h1>
                        <p class="logo-tagline">Focused Literacy. Clear Results</p>
                    </div>
                </div>
                <div class="header-school-info" id="headerSchoolInfo" title="Click to edit school details">
                    <!-- Populated via JS -->
                </div>
            </header>

            <div class="assessment-container">
                <div class="tasks-panel">
                    <div class="card">
                        <h2 class="card-title">
                            <span>ðŸ“‹</span> Assessment Tasks
                        </h2>
                        <ul class="task-list">
                            <li class="task-item" data-task="dashboard">
                                <span class="task-number"><i class="fas fa-chart-line"></i></span> Dashboard
                            </li>
                            <li class="task-item active" data-task="0">
                                <span class="task-number">0</span> Learner Enrollment
                            </li>
                            <li class="task-item" data-task="1">
                                <span class="task-number">1</span> <span id="task1MenuLabel">Letter Naming</span>
                            </li>
                            <li class="task-item" data-task="2">
                                <span class="task-number">2</span> Sentence Reading
                            </li>
                            <li class="task-item" data-task="3">
                                <span class="task-number">3</span> <span id="task3MenuLabel">Rhyming Words</span>
                            </li>
                            <li class="task-item" data-task="4">
                                <span class="task-number">4</span> Story Reading
                            </li>
                            <li class="task-item" data-task="5">
                                <span class="task-number">5</span> Results & Profile
                            </li>
                            <li class="task-item" data-task="6">
                                <span class="task-number">6</span> Data & Reports
                            </li>
                            <li class="task-item" data-task="interventions">
                                <span class="task-number">7</span> Interventions
                            </li>
                        </ul>
                    </div>

                    <div class="card">
                        <h2 class="card-title">
                            <span>ðŸ‘¤</span> Current Learner
                        </h2>
                        <div id="currentLearnerInfo">
                            <p style="color: #6c757d; font-style: italic;">No learner selected</p>
                        </div>
                        <!-- Language Selector for Grade 2/3 -->
                        <div id="assessmentLanguageContainer" class="hidden"
                            style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
                            <label class="form-label" for="assessmentLanguageSelector"
                                style="font-size: 0.9rem;">Assessment Language:</label>
                            <select id="assessmentLanguageSelector" class="form-input"
                                style="font-size: 0.9rem; padding: 8px;">
                                <!-- Populated dynamically -->
                            </select>
                        </div>
                    </div>
                </div>

                <div class="assessment-panel">

                    <!-- Task Dashboard -->
                    <div class="card task-content" id="taskdashboard">
                        <h2 class="card-title">
                            <span>ðŸ“Š</span> Class Dashboard
                        </h2>

                        <div class="dashboard-controls">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <strong>Data Source:</strong>
                                <select id="dashboardAssessmentPeriod" class="form-input"
                                    style="padding: 5px; font-size: 0.9rem; width: auto; max-width: 200px;">
                                    <option value="latest">Latest Assessment</option>
                                </select>
                            </div>
                            <button id="refreshDashboardBtn" class="btn btn-sm btn-secondary">
                                <i class="fas fa-sync-alt"></i> Refresh Data
                            </button>
                        </div>

                        <div class="chart-legend">
                            <div class="legend-item">
                                <div class="legend-box bar-male"></div> Male
                            </div>
                            <div class="legend-item">
                                <div class="legend-box bar-female"></div> Female
                            </div>
                        </div>

                        <div class="dashboard-grid">
                            <!-- 1. Learner Count -->
                            <div class="stat-panel">
                                <div class="panel-title"><i class="fas fa-users"></i> Learner Count</div>
                                <div id="dash-learner-count">
                                    <!-- Populated via JS -->
                                </div>
                            </div>

                            <!-- 2. Part 1 Level -->
                            <div class="stat-panel">
                                <div class="panel-title"><i class="fas fa-layer-group"></i> Assessment Part 1 Level
                                </div>
                                <div id="dash-p1-level">
                                    <!-- Populated via JS -->
                                </div>
                            </div>

                            <!-- 3. Part 2 Average -->
                            <div class="stat-panel">
                                <div class="panel-title"><i class="fas fa-chart-bar"></i> Part 2 Average Score</div>
                                <div id="dash-p2-avg">
                                    <!-- Populated via JS -->
                                </div>
                            </div>

                            <!-- 4. Reading Profile -->
                            <div class="stat-panel" style="grid-column: 1 / -1;">
                                <div class="panel-title"><i class="fas fa-book-reader"></i> Reading Profile Categories
                                </div>
                                <div class="dashboard-grid" style="margin-top:0; gap: 15px;">
                                    <div id="dash-profile-col1"></div>
                                    <div id="dash-profile-col2"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Task 0: Learner Enrollment -->
                    <div class="card task-content active" id="task0">
                        <h2 class="card-title">
                            <span>ðŸ‘¥</span> Task 0: Learner Enrollment
                        </h2>
                        <p>Enroll new learners or select existing learners for assessment.</p>

                        <div class="enrollment-container">
                            <div class="enrollment-form">
                                <h3>Enroll New Learner</h3>
                                <div class="form-group">
                                    <label class="form-label" for="learnerLRN">LRN (Learner Reference No.)</label>
                                    <input type="text" id="learnerLRN" class="form-input" placeholder="Enter LRN">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="learnerName">Full Name (Last Name, First Name,
                                        M.I.)</label>
                                    <input type="text" id="learnerName" class="form-input"
                                        placeholder="Enter learner's full name">
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="learnerAge">Age</label>
                                    <input type="number" id="learnerAge" class="form-input" placeholder="Enter age"
                                        min="5" max="15">
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="learnerGender">Gender</label>
                                    <select id="learnerGender" class="form-input">
                                        <option value="">Select gender</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="learnerGrade">Grade Level</label>
                                    <select id="learnerGrade" class="form-input">
                                        <option value="1">Grade 1</option>
                                        <option value="2">Grade 2</option>
                                        <option value="3">Grade 3</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="learnerLanguage">Primary Language</label>
                                    <select id="learnerLanguage" class="form-input">
                                        <option value="filipino">Filipino</option>
                                        <option value="bisaya">Sinugbuanong Bisaya</option>
                                        <option value="english">English</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="learnerNotes">Notes (Optional)</label>
                                    <textarea id="learnerNotes" class="form-input" rows="3"
                                        placeholder="Any additional notes about the learner"></textarea>
                                </div>

                                <div class="controls">
                                    <button id="enrollLearner" class="btn btn-success">
                                        <span>âž•</span> Enroll Learner
                                    </button>
                                    <button id="updateLearnerBtn" class="btn btn-warning hidden">
                                        <span>ðŸ’¾</span> Update Learner
                                    </button>
                                    <button id="cancelEditBtn" class="btn btn-secondary hidden">
                                        <span>âŒ</span> Cancel Edit
                                    </button>
                                    <button id="clearForm" class="btn btn-secondary">
                                        <span>ðŸ—‘ï¸</span> Clear Form
                                    </button>
                                </div>
                            </div>

                            <div class="enrolled-learners">
                                <h3>Enrolled Learners</h3>
                                <div class="form-group">
                                    <label class="form-label" for="enrolledLearnerSelect">Select Learner from
                                        List:</label>
                                    <select id="enrolledLearnerSelect" class="form-input"
                                        style="font-weight: 500; cursor: pointer;">
                                        <option value="">Loading...</option>
                                    </select>
                                    <div id="enrolledLearnerCount"
                                        style="margin-top: 5px; font-size: 0.9rem; color: #666; text-align: right;">
                                    </div>
                                </div>

                                <div class="form-group" style="margin-top: 15px;">
                                    <label class="form-label" for="assessmentTypeSelect">Assessment Type:</label>
                                    <select id="assessmentTypeSelect" class="form-input">
                                        <option value="Quarter I Pre-test">Quarter I Pre-test</option>
                                        <option value="Quarter I Post-test">Quarter I Post-test</option>
                                        <option value="Quarter II Pre-test">Quarter II Pre-test</option>
                                        <option value="Quarter II Post-test">Quarter II Post-test</option>
                                        <option value="Quarter III Pre-test">Quarter III Pre-test</option>
                                        <option value="Quarter III Post-test">Quarter III Post-test</option>
                                        <option value="Quarter IV Pre-test">Quarter IV Pre-test</option>
                                        <option value="Quarter IV Post-test">Quarter IV Post-test</option>
                                        <option value="Buffer Pre-test">Buffer Pre-test</option>
                                        <option value="Buffer Post-test">Buffer Post-test</option>
                                    </select>
                                </div>

                                <div class="controls" style="margin-top: 20px;">
                                    <button id="startAssessment" class="btn btn-primary" disabled>
                                        <span>ðŸ“</span> Start Assessment
                                    </button>
                                    <button id="editLearnerActionBtn" class="btn btn-secondary" disabled>
                                        <span>âœï¸</span> Edit Details
                                    </button>
                                    <button id="removeLearner" class="btn btn-danger" disabled>
                                        <span>âž–</span> Remove Learner
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Task 1: Letter/Word Naming -->
                    <div class="card task-content" id="task1">
                        <h2 class="card-title">
                            <span>ðŸ”¤</span> <span id="task1Title">Task 1: Letter Naming</span>
                        </h2>
                        <p id="task1Instructions">Present the learner with the sheet containing the letters. Click on
                            any letter to edit it.</p>

                        <div class="assessment-item">
                            <div class="assessment-text">
                                <strong>Items to assess:</strong>
                            </div>

                            <div class="controls" style="margin-bottom: 15px;">
                                <button class="btn btn-secondary hidden" id="toggleTask1Edit">
                                    <span>âœï¸</span> Edit Sentences
                                </button>
                            </div>

                            <div id="task1EditArea" class="edit-area-container">
                                <textarea id="task1Input" class="edit-textarea" rows="4"
                                    placeholder="Enter sentences, one per line (at least 2)."></textarea>
                                <button class="btn btn-success" id="saveTask1Sentences">Save</button>
                                <button class="btn btn-secondary" id="cancelTask1Edit">Cancel</button>
                            </div>

                            <div class="letters-container" id="lettersContainer"></div>

                            <div class="score-display">
                                Score: <span id="letterScoreDisplay">0</span> / <span id="totalLetters">10</span>
                            </div>

                            <div class="controls">
                                <div class="slider-control">
                                    <label>Size:</label>
                                    <input type="range" id="letterSizeSlider" min="1.0" max="5" step="0.2" value="2.5">
                                </div>
                                <button class="btn btn-secondary" id="playLetters">
                                    <span>ðŸ”Š</span> Play Items
                                </button>
                                <button class="btn btn-secondary" id="resetLetters">
                                    <span>ðŸ”„</span> Reset Assessment
                                </button>
                                <button class="btn btn-secondary" id="addLetter">
                                    <span>âž•</span> Add Item
                                </button>
                            </div>
                        </div>

                        <div class="controls">
                            <button class="btn btn-primary" id="nextTask1">
                                Next Task <span>â†’</span>
                            </button>
                        </div>
                    </div>

                    <!-- Task 2: Sentence Reading -->
                    <div class="card task-content" id="task2">
                        <h2 class="card-title">
                            <span>ðŸ“–</span> Task 2: Sentence Reading
                        </h2>
                        <p>Learner reads the sentences below. Click on a word to mark a miscue.</p>

                        <div class="assessment-item">
                            <div class="controls" style="margin-bottom: 15px;">
                                <button class="btn btn-secondary" id="toggleSentenceEdit">
                                    <span>âœï¸</span> Edit Sentences
                                </button>
                            </div>

                            <div id="sentenceEditArea" class="edit-area-container">
                                <textarea id="sentenceInput" class="edit-textarea" rows="4"></textarea>
                                <button class="btn btn-success" id="saveSentences">Save</button>
                            </div>

                            <div id="sentenceDisplay" class="sentence-display">
                                <!-- Dynamic Content -->
                            </div>

                            <div class="score-display">
                                Score: <span id="sentenceScoreDisplay">10</span> / 10
                            </div>

                            <div class="controls">
                                <div class="slider-control">
                                    <label>Size:</label>
                                    <input type="range" id="sentenceSizeSlider" min="1.5" max="4" step="0.2" value="2">
                                </div>
                                <button class="btn btn-secondary" id="resetSentences">
                                    <span>ðŸ”„</span> Reset
                                </button>
                                <button class="btn btn-secondary" id="playSentences">
                                    <span>ðŸ”Š</span> Play Sentences
                                </button>
                            </div>
                        </div>

                        <div class="controls">
                            <button class="btn btn-primary" id="nextTask2">
                                Next Task <span>â†’</span>
                            </button>
                        </div>
                    </div>

                    <!-- Task 3: Rhyming / Word ID -->
                    <div class="card task-content" id="task3">
                        <h2 class="card-title">
                            <span>ðŸŽµ</span> <span id="task3Title">Task 3: Rhyming Words</span>
                        </h2>
                        <p id="task3Instructions"><strong>Teacher:</strong> Read the pair. Ask if they rhyme. Mark
                            response.</p>

                        <div class="assessment-item">
                            <div class="rhyme-list-container" id="rhymePairsContainer"></div>

                            <div class="score-display">
                                Score: <span id="rhymeScoreDisplay">0</span> / <span id="totalRhymes">10</span>
                            </div>

                            <div class="controls">
                                <button class="btn btn-secondary" id="addRhymePair">
                                    <span>âž•</span> Add Item
                                </button>
                                <button class="btn btn-secondary" id="playRhymes">
                                    <span>ðŸ”Š</span> Play Items
                                </button>
                                <button class="btn btn-secondary" id="resetRhymes">
                                    <span>ðŸ”„</span> Reset
                                </button>
                            </div>
                        </div>

                        <div class="controls">
                            <button class="btn btn-primary" id="nextTask3">
                                Next Task <span>â†’</span>
                            </button>
                        </div>
                    </div>

                    <!-- Task 4: Story Reading (REVISED) -->
                    <div class="card task-content" id="task4">
                        <h2 class="card-title">
                            <span>ðŸ“š</span> Task 4: Story Reading
                        </h2>

                        <div class="assessment-item">
                            <div class="passage-controls">
                                <select id="storyPassageSelect" class="passage-select"></select>
                                <div class="slider-control" style="display:flex; align-items:center; gap:5px;">
                                    <label>Size:</label>
                                    <input type="range" id="storySizeSlider" min="1" max="3" step="0.1" value="1.5">
                                </div>
                                <button class="btn btn-secondary" id="addStoryBtn"
                                    style="padding: 8px 15px; font-size: 0.9rem;">Add New</button>
                                <button class="btn btn-danger" id="deleteStoryBtn"
                                    style="padding: 8px 15px; font-size: 0.9rem;">Delete</button>
                            </div>

                            <div class="controls" style="margin-bottom: 15px;">
                                <button class="btn btn-secondary" id="toggleStoryEdit">
                                    <span>âœï¸</span> Edit Story & Questions
                                </button>
                            </div>

                            <!-- Edit Area for Story & Questions -->
                            <div id="storyEditArea" class="edit-area-container">
                                <div class="form-group">
                                    <label class="form-label">Story Title</label>
                                    <input type="text" id="editStoryTitle" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Story Content</label>
                                    <textarea id="editStoryContent" class="edit-textarea" rows="6"></textarea>
                                </div>

                                <h4>Comprehension Questions</h4>
                                <div id="editQuestionsContainer" style="margin-bottom: 15px;">
                                    <!-- Dynamic Inputs -->
                                </div>
                                <button class="btn btn-secondary" id="addQuestionInput" style="margin-bottom: 15px;">+
                                    Add Question</button>

                                <div class="controls">
                                    <button class="btn btn-success" id="saveStoryChanges">Save Changes</button>
                                    <button class="btn btn-secondary" id="cancelStoryEdit">Cancel</button>
                                </div>
                            </div>

                            <!-- Timer Control -->
                            <div class="timer-controls">
                                <span>Timer Duration:</span>
                                <select id="timerDurationSelect" class="form-input" style="width: auto;">
                                    <option value="60">1 Minute</option>
                                    <option value="120">2 Minutes</option>
                                    <option value="180">3 Minutes</option>
                                </select>
                                <div class="timer-display" id="timerDisplay">01:00</div>
                                <button class="btn btn-primary" id="startTimerBtn">Start</button>
                                <button class="btn btn-secondary" id="resetTimerBtn">Reset</button>
                            </div>

                            <!-- Story Display -->
                            <h3 style="font-size: 1.1rem; margin-bottom: 10px;">Reading Passage (Click word for miscue)
                            </h3>
                            <div class="story-display" id="storyDisplayArea">
                                <!-- Dynamic Content -->
                            </div>

                            <!-- Calculated Metrics -->
                            <div class="grid grid-cols-3 gap-4 mb-4" style="display: flex; gap: 20px; flex-wrap: wrap;">
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">Total Words in Story</label>
                                    <input type="number" id="totalStoryWords" class="form-input" readonly>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">Miscues (Auto)</label>
                                    <input type="number" id="miscuesCount" class="form-input" value="0" readonly>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">Words Read (Total - Miscues)</label>
                                    <input type="number" id="wordsReadInput" class="form-input" readonly>
                                </div>
                            </div>

                            <!-- Comprehension -->
                            <div class="comprehension-section">
                                <h3 style="margin-bottom: 15px;">Comprehension Check</h3>
                                <div id="questionsDisplayArea">
                                    <!-- Dynamic -->
                                </div>
                                <div class="score-display" style="margin-top: 20px;">
                                    Comprehension Score: <span id="compScoreDisplay">0</span> / <span
                                        id="totalQuestionsDisplay">5</span>
                                </div>
                            </div>

                            <!-- Observation Levels (1-4) -->
                            <div class="observation-panel">
                                <div class="observation-title">Reading Fluency Observation</div>
                                <div class="observation-options">
                                    <div class="observation-option" data-level="1">
                                        <span class="level-label">LEVEL 1</span>
                                        <span class="level-desc">Word by word or lower</span>
                                    </div>
                                    <div class="observation-option" data-level="2">
                                        <span class="level-label">LEVEL 2</span>
                                        <span class="level-desc">Reads words in chunks</span>
                                    </div>
                                    <div class="observation-option" data-level="3">
                                        <span class="level-label">LEVEL 3</span>
                                        <span class="level-desc">Fluent, ignores punctuation</span>
                                    </div>
                                    <div class="observation-option" data-level="4">
                                        <span class="level-label">LEVEL 4</span>
                                        <span class="level-desc">Fluent with expression</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Mood Scale -->
                            <div class="mood-scale">
                                <div class="mood-title">Learner's Experience</div>
                                <div class="mood-container">
                                    <div class="mood-item" data-mood="1">
                                        <span class="mood-number">1</span>
                                        <span class="mood-emoji">ðŸ˜ </span>
                                    </div>
                                    <div class="mood-item" data-mood="2">
                                        <span class="mood-number">2</span>
                                        <span class="mood-emoji">ðŸ˜”</span>
                                    </div>
                                    <div class="mood-item" data-mood="3">
                                        <span class="mood-number">3</span>
                                        <span class="mood-emoji">ðŸ˜</span>
                                    </div>
                                    <div class="mood-item" data-mood="4">
                                        <span class="mood-number">4</span>
                                        <span class="mood-emoji">ðŸ™‚</span>
                                    </div>
                                    <div class="mood-item" data-mood="5">
                                        <span class="mood-number">5</span>
                                        <span class="mood-emoji">ðŸ˜„</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="controls">
                            <button class="btn btn-primary" id="nextTask4">
                                View Results <span>â†’</span>
                            </button>
                        </div>
                    </div>

                    <!-- Task 5: Results & Profile -->
                    <div class="card task-content" id="task5">
                        <h2 class="card-title">
                            <span>ðŸ“Š</span> Task 5: Results & Reading Profile
                        </h2>

                        <div class="profile-card">
                            <h3 class="profile-title" id="profileResult">Full Refresher</h3>
                            <p class="profile-description" id="profileDescription">...</p>
                        </div>

                        <div class="assessment-item">
                            <h3>Assessment Scores</h3>
                            <table style="width: 100%; margin-top: 15px; border-collapse: collapse;">
                                <tr>
                                    <td style="padding: 8px; border-bottom: 1px solid #dee2e6;" id="row1Label">Letter
                                        Naming</td>
                                    <td style="padding: 8px; border-bottom: 1px solid #dee2e6;" id="score1">0/10</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px; border-bottom: 1px solid #dee2e6;">Sentence Reading</td>
                                    <td style="padding: 8px; border-bottom: 1px solid #dee2e6;" id="score2">N/A</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px; border-bottom: 1px solid #dee2e6;" id="row3Label">Rhyming
                                        Words</td>
                                    <td style="padding: 8px; border-bottom: 1px solid #dee2e6;" id="score3">0/10</td>
                                </tr>
                                <tr>
                                    <td
                                        style="padding: 8px; border-bottom: 1px solid #dee2e6; background-color: #f0f8ff; font-weight: bold;">
                                        PART 1 PROFILE</td>
                                    <td style="padding: 8px; border-bottom: 1px solid #dee2e6; background-color: #f0f8ff; font-weight: bold;"
                                        id="part1ProfileDisplay">-</td>
                                </tr>
                                <tr id="part2HeaderRow">
                                    <td colspan="2"
                                        style="padding: 10px; background-color: #e9ecef; font-weight: bold; text-align: center;">
                                        PART 2: FLUENCY & COMPREHENSION</td>
                                </tr>
                                <tr class="part2-row">
                                    <td style="padding: 8px; border-bottom: 1px solid #dee2e6;">Reading Time</td>
                                    <td style="padding: 8px; border-bottom: 1px solid #dee2e6;" id="scoreTime">0s</td>
                                </tr>
                                <tr class="part2-row">
                                    <td style="padding: 8px; border-bottom: 1px solid #dee2e6;">Words Per Minute (WPM)
                                    </td>
                                    <td style="padding: 8px; border-bottom: 1px solid #dee2e6;" id="scoreWPM">0</td>
                                </tr>
                                <tr class="part2-row">
                                    <td style="padding: 8px; border-bottom: 1px solid #dee2e6;">Accuracy (%)</td>
                                    <td style="padding: 8px; border-bottom: 1px solid #dee2e6;" id="scoreAccuracy">0%
                                    </td>
                                </tr>
                                <tr class="part2-row">
                                    <td style="padding: 8px; border-bottom: 1px solid #dee2e6;">Comprehension</td>
                                    <td style="padding: 8px; border-bottom: 1px solid #dee2e6;" id="scoreComp">0/5</td>
                                </tr>
                            </table>
                        </div>

                        <div class="controls">
                            <button class="btn btn-success" id="saveResults">
                                <span>ðŸ’¾</span> Save Assessment
                            </button>
                            <button class="btn btn-secondary" id="newAssessment">
                                <span>ðŸ”„</span> New Assessment
                            </button>
                        </div>
                    </div>

                    <!-- Task 6: Data & Reports -->
                    <div class="card task-content" id="task6">
                        <h2 class="card-title">
                            <span>ðŸ“ˆ</span> Task 6: Data & Reports
                        </h2>

                        <div class="reports-container">
                            <!-- ROW 1: Inputs -->
                            <div class="reports-inputs-row">
                                <select id="reportLearnerSelect" class="form-input" style="flex: 1;">
                                    <option value="">Select a learner</option>
                                </select>
                                <select id="assessmentIndexSelect" class="form-input" style="flex: 1; max-width: 250px;"
                                    disabled>
                                    <option value="">Select Assessment</option>
                                </select>
                            </div>

                            <!-- Class Reports Settings -->
                            <div
                                style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dee2e6;">
                                <h4 style="margin-bottom: 10px; color: var(--secondary);">Class Reports Settings</h4>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <label for="classAssessmentPeriod" style="font-weight: 600;">Select Assessment
                                        Period:</label>
                                    <select id="classAssessmentPeriod" class="form-input" style="max-width: 250px;">
                                        <option value="latest">Latest Available (Default)</option>
                                    </select>
                                </div>
                                <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                                    Applies to: Reading Scoresheet, Class Record, and Class Summary.
                                </p>
                            </div>

                            <!-- ROW 2: Action Buttons -->
                            <div class="reports-buttons-row">
                                <button type="button" id="generateReport" class="btn btn-primary">
                                    <span>ðŸ“Š</span> View Data
                                </button>
                                <button type="button" id="exportStudentPDF" class="btn btn-success">
                                    <span>ðŸ“„</span> PDF (Student)
                                </button>
                                <button type="button" id="exportClassPDF" class="btn btn-warning">
                                    <span>ðŸ«</span> Reading Scoresheet
                                </button>
                                <button type="button" id="exportClassRecordPDF" class="btn btn-info">
                                    <span>ðŸ“‹</span> Class Record
                                </button>
                                <button type="button" id="exportClassSummaryPDF" class="btn"
                                    style="background: linear-gradient(to right, #16a085, #1abc9c); color: white;">
                                    <span>ðŸ“‘</span> Class Summary
                                </button>
                                <button type="button" id="exportProgressPDF" class="btn"
                                    style="background: linear-gradient(to right, #8e44ad, #9b59b6); color: white;">
                                    <span>ðŸ“ˆ</span> Progress (PDF)
                                </button>
                                <button type="button" id="showProgressBtn" class="btn"
                                    style="background: linear-gradient(to right, #3498db, #2980b9); color: white;">
                                    <span>ðŸ“ˆ</span> View Progress
                                </button>
                                <button type="button" id="editSchoolInfoBtn" class="btn btn-secondary">
                                    <span>ðŸ«</span> Edit School Info
                                </button>
                                <button type="button" id="deleteAssessmentBtn" class="btn btn-danger" disabled>
                                    <span>ðŸ—‘ï¸</span> Delete Assessment
                                </button>
                            </div>

                            <!-- Report Tabs -->
                            <div class="report-tabs">
                                <div class="report-tab active" id="tabIndividual">Individual Report</div>
                                <div class="report-tab" id="tabProgress">Progress History</div>
                            </div>

                            <div class="report-card" id="learnerReport">
                                <div class="report-header">
                                    <h3 class="report-title">Learner Assessment Report</h3>
                                </div>
                                <div id="reportContent">
                                    <p style="color: #6c757d; font-style: italic; text-align: center;">
                                        Select a learner and generate a report to view data here.
                                    </p>
                                </div>
                            </div>

                            <div class="report-card" id="progressReportCard" style="display: none;">
                                <div class="report-header">
                                    <h3 class="report-title">Student Progress Report</h3>
                                </div>
                                <div id="progressReportContent">
                                    <table class="assessment-history">
                                        <thead>
                                            <tr>
                                                <th>Assessment #</th>
                                                <th>Date</th>
                                                <th>Final Profile</th>
                                                <th>Percentage (%)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="progressReportBody"></tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="report-card">
                                <h3 class="report-title">All Learners Summary</h3>
                                <table class="assessment-history" id="allLearnersTable">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Age</th>
                                            <th>Grade</th>
                                            <th>Assessments</th>
                                            <th>Last Profile</th>
                                        </tr>
                                    </thead>
                                    <tbody id="allLearnersBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Task 7: Interventions -->
                    <div class="card task-content" id="taskinterventions">
                        <h2 class="card-title">
                            <span>ðŸ§ </span> Interventions
                        </h2>
                        <div class="reports-container">
                            <div class="reports-inputs-row">
                                <select id="interventionLearnerSelect" class="form-input" style="flex: 1;">
                                    <option value="">Select a learner</option>
                                </select>
                                <select id="interventionIndexSelect" class="form-input"
                                    style="flex: 1; max-width: 250px;" disabled>
                                    <option value="">Select Assessment</option>
                                </select>
                            </div>
                            <div class="reports-buttons-row">
                                <button type="button" id="generateInterventionBtn" class="btn btn-primary">
                                    <span>ðŸ’¡</span> Generate Intervention Plan
                                </button>
                                <button type="button" id="exportInterventionPDF" class="btn btn-success" disabled>
                                    <span>ðŸ“„</span> Export to PDF
                                </button>
                            </div>
                            <div class="report-card" id="interventionPlanCard">
                                <div class="report-header">
                                    <h3 class="report-title">Intervention Plan</h3>
                                </div>
                                <div id="interventionPlanContent">
                                    <p style="color: #6c757d; font-style: italic; text-align: center;">
                                        Select a learner and an assessment to generate an intervention plan.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>ReadLens - Focused Literacy. Clear Results | Developed by GLENN MARK S. PRESORES and
                ROSAVELIA O. JIMENEZ </p>
        </footer>
    </div>

    <!-- School Details Modal -->
    <div class="modal-overlay" id="schoolDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">School & Teacher Details</h3>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px; color: #666;">Please enter these details for the reports.</p>
                <div class="form-group">
                    <label class="form-label">School Name</label>
                    <input type="text" id="modalSchoolName" class="form-input"
                        placeholder="e.g. Central Elementary School">
                </div>
                <div class="form-group">
                    <label class="form-label">Grade & Section</label>
                    <input type="text" id="modalGradeSection" class="form-input" placeholder="e.g. Grade 1 - Rose">
                </div>
                <div class="form-group">
                    <label class="form-label">Teacher's Name</label>
                    <input type="text" id="modalTeacherName" class="form-input" placeholder="e.g. Mrs. Santos">
                </div>
                <div class="form-group">
                    <label class="form-label">Assessment Feedback Voice</label>
                    <select id="voiceSelector" class="form-input">
                        <option value="">Default System Voice</option>
                    </select>
                    <p style="font-size: 0.8rem; color: #888; margin-top: 5px;">Choose a voice for assessment
                        feedback.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="saveSchoolDetailsBtn">Save Details</button>
            </div>
        </div>
    </div>
    </div> <!-- End of App Wrapper -->

    <!-- Include jsPDF library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {

            // ==========================================
            // EMAIL JS CONFIGURATION
            // ==========================================
            const EMAILJS_PUBLIC_KEY = "YOUR_PUBLIC_KEY";
            const EMAILJS_SERVICE_ID = "YOUR_SERVICE_ID";
            const EMAILJS_TEMPLATE_ID = "YOUR_TEMPLATE_ID";

            try {
                if (window.emailjs) emailjs.init(EMAILJS_PUBLIC_KEY);
            } catch (e) { console.error("EmailJS init fail", e); }

            // GLOBAL ERROR HANDLER
            window.onerror = function (msg, url, lineNo, columnNo, error) {
                console.error("Global Error:", msg, error);
                return false;
            };

            // GLOBAL ERROR HANDLER
            window.onerror = function (msg, url, lineNo, columnNo, error) {
                console.error("Global Error:", msg, error);
                return false;
            };

            // ==========================================
            // GLOBAL VARIABLES
            // ==========================================
            const USER_EDITS_KEY = 'readLens_userEdits';
            let userEdits = {};

            // ==========================================
            // AUTHENTICATION LOGIC
            // ==========================================

            const authWrapper = document.getElementById('authWrapper');
            const appWrapper = document.getElementById('appWrapper');
            const loginSection = document.getElementById('loginFormSection');
            const registerSection = document.getElementById('registerFormSection');

            function getStoredUser() {
                try {
                    const data = localStorage.getItem('readLens_user');
                    return data ? JSON.parse(data) : null;
                } catch (e) {
                    console.error("Auth storage error", e);
                    return null;
                }
            }

            const existingUser = getStoredUser();

            if (existingUser) {
                if (loginSection) loginSection.classList.remove('hidden');
                if (registerSection) registerSection.classList.add('hidden');
                const userObj = existingUser;
                const loginUser = document.getElementById('loginUsername');
                if (loginUser) loginUser.value = userObj.name || '';
            } else {
                if (loginSection) loginSection.classList.add('hidden');
                if (registerSection) registerSection.classList.remove('hidden');
            }

            const showRegisterLink = document.getElementById('showRegister');
            if (showRegisterLink) showRegisterLink.addEventListener('click', () => {
                loginSection.classList.add('hidden');
                registerSection.classList.remove('hidden');
            });

            const showLoginLink = document.getElementById('showLogin');
            if (showLoginLink) showLoginLink.addEventListener('click', () => {
                registerSection.classList.add('hidden');
                loginSection.classList.remove('hidden');
            });

            const btnRegister = document.getElementById('btnRegister');
            if (btnRegister) btnRegister.addEventListener('click', () => {
                const name = document.getElementById('regName').value.trim();
                const school = document.getElementById('regSchool').value.trim();
                const grade = document.getElementById('regGrade').value.trim();
                const password = document.getElementById('regPassword').value.trim();
                const secretCode = document.getElementById('regSecretCode').value.trim();
                const validCode = "qwe123";

                if (name && school && grade && password) {
                    if (secretCode !== validCode) {
                        alert("Invalid Secret Code. Security alert sent to administrator.");
                        return;
                    }

                    const userObj = { name, school, grade, password };
                    localStorage.setItem('readLens_user', JSON.stringify(userObj));
                    localStorage.setItem('crlaSchoolName', school);
                    localStorage.setItem('crlaGradeSection', grade);
                    localStorage.setItem('crlaTeacherName', name);

                    alert("Account created! Please log in.");
                    registerSection.classList.add('hidden');
                    loginSection.classList.remove('hidden');
                    const loginUser = document.getElementById('loginUsername');
                    if (loginUser) loginUser.value = name;
                } else {
                    alert("Please fill in all fields.");
                }
            });

            const btnLogin = document.getElementById('btnLogin');
            if (btnLogin) btnLogin.addEventListener('click', () => {
                const username = document.getElementById('loginUsername').value.trim();
                const password = document.getElementById('loginPassword').value.trim();
                const storedUser = getStoredUser();

                if (storedUser) {
                    if (storedUser.name === username && storedUser.password === password) {
                        authWrapper.classList.add('hidden');
                        appWrapper.classList.remove('hidden');
                        initializeApp();
                    } else {
                        alert("Invalid username or password.");
                    }
                } else {
                    alert("No user found. Please create an account.");
                }
            });

            // ==========================================
            // APP INITIALIZATION
            // ==========================================
            function initializeApp() {
                console.log("Initializing App...");

                // 0. Load User Edits and Cache FIRST
                try {
                    const savedEdits = localStorage.getItem(USER_EDITS_KEY);
                    if (savedEdits) {
                        userEdits = JSON.parse(savedEdits);
                        console.log("User edits loaded:", userEdits);
                    }
                } catch (e) {
                    console.error("Failed to load user edits:", e);
                }

                // 1. Initialize Tabs (Priority)
                const taskItems = document.querySelectorAll('.task-item');
                taskItems.forEach(item => {
                    item.addEventListener('click', function () {
                        const taskId = this.getAttribute('data-task');
                        switchTask(taskId);
                        if (taskId === 'dashboard') renderDashboard();
                    });
                });

                // 2. Initialize Components safely
                safeInit(updateHeaderDisplay);
                safeInit(initializeLetterAssessment);
                safeInit(initializeEnrollment);
                safeInit(initializeSentenceReading);
                safeInit(initializeRhymeAssessment);
                safeInit(initializeStoryAssessment);
                safeInit(renderAllLearnersTable);
                safeInit(updateDashboardDropdown);

                safeInit(updateDashboardDropdown);

                // 3. Ensure we start at Dashboard
                switchTask('dashboard');
                renderDashboard();

                // Dashboard Refresh Button
                const dashRefresh = document.getElementById('refreshDashboardBtn');
                if (dashRefresh) dashRefresh.addEventListener('click', renderDashboard);

                // Dashboard Dropdown Listener
                const dashPeriodSel = document.getElementById('dashboardAssessmentPeriod');
                if (dashPeriodSel) dashPeriodSel.addEventListener('change', renderDashboard);
            }

            function safeInit(fn) {
                try {
                    fn();
                } catch (e) {
                    console.error("Initialization error in " + fn.name, e);
                }
            }

            // ==========================================
            // DASHBOARD LOGIC
            // ==========================================
            function updateDashboardDropdown() {
                const sel = document.getElementById('dashboardAssessmentPeriod');
                if (!sel) return;
                let max = 0;
                if (learners) learners.forEach(l => { if (l.assessments && l.assessments.length > max) max = l.assessments.length; });

                const current = sel.value;
                let html = '<option value="latest">Latest Assessment</option>';
                for (let i = 0; i < max; i++) {
                    html += `<option value="${i}">Assessment ${i + 1}</option>`;
                }

                // Only update if innerHTML is different to prevent reset issues, though for simple selects replacing is usually fine
                if (sel.innerHTML !== html) {
                    sel.innerHTML = html;
                    if (current && (current === 'latest' || parseInt(current) < max)) {
                        sel.value = current;
                    } else {
                        sel.value = 'latest';
                    }
                }
            }

            // REDESIGNED: Vertical Chart Rendering
            function renderVerticalChart(containerId, data, maxVal) {
                const container = document.getElementById(containerId);
                if (!container) return;
                container.innerHTML = '';

                const chartBox = document.createElement('div');
                chartBox.className = 'vertical-chart';

                data.forEach(d => {
                    const mPct = maxVal > 0 ? Math.min((d.m / maxVal) * 100, 100) : 0;
                    const fPct = maxVal > 0 ? Math.min((d.f / maxVal) * 100, 100) : 0;

                    chartBox.innerHTML += `
                        <div class="v-category">
                            <div class="v-bars-group">
                                <div class="v-bar bar-male" style="height: ${mPct}%;">
                                    ${d.m > 0 ? `<span class="v-bar-value">${d.m}</span>` : ''}
                                </div>
                                <div class="v-bar bar-female" style="height: ${fPct}%;">
                                    ${d.f > 0 ? `<span class="v-bar-value">${d.f}</span>` : ''}
                                </div>
                            </div>
                            <div class="v-label">${d.label}</div>
                        </div>
                    `;
                });
                container.appendChild(chartBox);
            }

            function renderDashboard() {
                // Statistics similar to Class Summary
                const stats = {
                    male: { enrolled: 0, assessed: 0, p1: {}, p2: { wpm: 0, acc: 0, comp: 0, count: 0 }, profile: {} },
                    female: { enrolled: 0, assessed: 0, p1: {}, p2: { wpm: 0, acc: 0, comp: 0, count: 0 }, profile: {} }
                };

                // Helper to init counts
                const initCounts = (obj) => {
                    obj.p1["Full Refresher"] = 0; obj.p1["Moderate Refresher"] = 0; obj.p1["Light Refresher"] = 0; obj.p1["Grade Ready"] = 0;
                    obj.profile["Low Emerging Reader"] = 0; obj.profile["High Emerging Reader"] = 0;
                    obj.profile["Developing Reader"] = 0; obj.profile["Transitioning Reader"] = 0; obj.profile["Reading At Grade Level"] = 0;
                };
                initCounts(stats.male); initCounts(stats.female);

                // GET SELECTED SOURCE
                const dashSel = document.getElementById('dashboardAssessmentPeriod');
                const dashVal = dashSel ? dashSel.value : 'latest';
                const isLatest = dashVal === 'latest';
                const targetIdx = isLatest ? -1 : parseInt(dashVal);

                learners.forEach(l => {
                    const isMale = (l.gender || '').toLowerCase() === 'male';
                    const target = isMale ? stats.male : stats.female;
                    target.enrolled++;

                    // Use selected assessment
                    let last = null;
                    if (l.assessments && l.assessments.length > 0) {
                        if (isLatest) {
                            last = l.assessments[l.assessments.length - 1];
                        } else if (l.assessments[targetIdx]) {
                            last = l.assessments[targetIdx];
                        }
                    }

                    if (last) {
                        target.assessed++;
                        const p1Prof = last.part1?.profile;
                        if (p1Prof && target.p1[p1Prof] !== undefined) target.p1[p1Prof]++;
                        if (last.part2) {
                            target.p2.count++; target.p2.wpm += (last.part2.wpm || 0); target.p2.acc += (last.part2.accuracy || 0); target.p2.comp += ((last.part2.comp || 0) / 5) * 100;
                        }
                        const fProf = last.finalProfile;
                        if (fProf && target.profile[fProf] !== undefined) target.profile[fProf]++;
                    }
                });

                const getAvg = (sum, count) => count > 0 ? Math.round(sum / count) : 0;

                // 1. Learner Count
                const maxCount = Math.max(stats.male.enrolled, stats.female.enrolled, 10);
                renderVerticalChart('dash-learner-count', [
                    { label: 'Enrolled', m: stats.male.enrolled, f: stats.female.enrolled },
                    { label: 'Assessed', m: stats.male.assessed, f: stats.female.assessed }
                ], maxCount);

                // 2. Part 1 Level
                const p1Data = [
                    "Full Refresher", "Moderate Refresher", "Light Refresher", "Grade Ready"
                ].map(k => ({
                    label: k.replace('Refresher', 'Ref.'),
                    m: stats.male.p1[k],
                    f: stats.female.p1[k]
                }));
                const maxP1 = Math.max(...p1Data.map(d => Math.max(d.m, d.f)), 5); // Minimum max of 5
                renderVerticalChart('dash-p1-level', p1Data, maxP1);

                // 3. Part 2 Average
                const mAcc = getAvg(stats.male.p2.acc, stats.male.p2.count);
                const fAcc = getAvg(stats.female.p2.acc, stats.female.p2.count);
                const mComp = getAvg(stats.male.p2.comp, stats.male.p2.count);
                const fComp = getAvg(stats.female.p2.comp, stats.female.p2.count);
                const mWPM = getAvg(stats.male.p2.wpm, stats.male.p2.count);
                const fWPM = getAvg(stats.female.p2.wpm, stats.female.p2.count);

                // For combined metric chart, assume scale relative to "Good Performance".
                // 100% Accuracy is full bar. 100% Comp is full bar. 100 WPM is full bar.
                // We'll set maxVal to 100, but allow WPM to go slightly over if needed visually? 
                // Vertical bar logic caps at 100%. So let's use Math.max(100, maxWPM)
                const maxAvg = Math.max(100, mWPM, fWPM);

                renderVerticalChart('dash-p2-avg', [
                    { label: 'Accuracy (%)', m: mAcc, f: fAcc },
                    { label: 'Comp (%)', m: mComp, f: fComp },
                    { label: 'WPM', m: mWPM, f: fWPM }
                ], maxAvg);

                // 4. Reading Profile (Split in 2 columns)
                const profileKeys = [
                    "Low Emerging Reader", "High Emerging Reader",
                    "Developing Reader", "Transitioning Reader", "Reading At Grade Level"
                ];
                const allProfileData = profileKeys.map(k => ({
                    label: k.replace('Reader', '').replace('Reading', '').trim(), // Shorten labels
                    m: stats.male.profile[k],
                    f: stats.female.profile[k]
                }));
                const maxProf = Math.max(...allProfileData.map(d => Math.max(d.m, d.f)), 5);

                renderVerticalChart('dash-profile-col1', allProfileData.slice(0, 3), maxProf);
                renderVerticalChart('dash-profile-col2', allProfileData.slice(3), maxProf);
            }

            // ==========================================
            // GLOBAL VARIABLES & CRLA DATA
            // ==========================================
            const correctSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3');
            const incorrectSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3');

            const affirmativePhrases = ["Good Job!", "Very Good!", "Way to go!", "Excellent!", "Awesome!", "Super job!", "You're a star!", "Amazing work!", "Fantastic!", "Wow! You got it!", "Great reading!", "High five!", "You're doing great!", "Brilliant!", "Look at you go!", "Smart cookie!", "Terrific!"];
            const negativePhrases = ["Oops!", "Nice try!", "Keep going!", "Try again!", "You can do it!", "Almost there!", "Close! Give it another shot!", "Let's try that one again.", "Don't give up!", "You'll get it next time!", "Think about it once more.", "Nice effort!", "Keep practicing!", "It's okay, try another one.", "Almost! Try once more."];

            function playFeedback(isCorrect) {
                if (isCorrect) {
                    correctSound.play().catch(e => { });
                    const phrase = affirmativePhrases[Math.floor(Math.random() * affirmativePhrases.length)];
                    speakText(phrase, 'en-US');
                } else {
                    incorrectSound.play().catch(e => { });
                    const phrase = negativePhrases[Math.floor(Math.random() * negativePhrases.length)];
                    speakText(phrase, 'en-US');
                }
            }

            let availableVoices = [];
            function populateVoices() {
                if (!('speechSynthesis' in window)) return;
                availableVoices = window.speechSynthesis.getVoices();
                const selector = document.getElementById('voiceSelector');
                if (!selector) return;

                const currentVoiceURI = localStorage.getItem('readLens_voiceURI');
                selector.innerHTML = '<option value="">Default System Voice</option>';

                availableVoices.forEach(voice => {
                    const opt = document.createElement('option');
                    opt.value = voice.voiceURI;
                    opt.textContent = `${voice.name} (${voice.lang})`;
                    if (voice.voiceURI === currentVoiceURI) opt.selected = true;
                    selector.appendChild(opt);
                });
            }

            if ('speechSynthesis' in window) {
                window.speechSynthesis.onvoiceschanged = populateVoices;
                populateVoices();
            }

            let learners = [];
            let currentLearnerId = null;
            let activeAssessmentLang = "";
            let activeAssessmentLabel = ""; // Stores "Quarter I Pre-test", etc.
            let task1WordMiscues = {}; // { itemIdx: [wordIdx, ...] }

            // DEFAULT DATA SETS

            // DEFAULT DATA SETS
            const assessmentData = {
                "1": { // Grade 1
                    "default": {
                        task1: { title: "Letter Naming", items: ['a', 'W', 'U', 'm', 'O', 'P', 'ng', 'b', 't', 'Y'], type: "letter" },
                        task2: { sentences: ["Ang bata nagdula sa gawas.", "Si Nanay nagluto og pagkaon."] },
                        task3: { title: "Rhyming Words", items: [{ pair: "bulsa - tasa" }, { pair: "libro - kwarto" }, { pair: "balay - kalay" }, { pair: "sapatos - lapis" }, { pair: "lingin - pinggan" }], type: "rhyme" },
                        story: { time: 60 }
                    }
                },
                "2": { // Grade 2
                    "filipino": {
                        task1: { title: "Sentence Recognition (Filipino)", items: ["Ang bola ay bilog.", "Kumain ka na ba?", "Tumakbo ang aso.", "Mainit ang araw.", "Masaya si Ana.", "Nasaan ang libro?", "Uminom ng tubig.", "Bukas ang pinto.", "Sino ang kasama mo?", "Malaki ang bahay."], type: "sentence" },
                        task2: { sentences: ["Si Ben ay may bagong bola.", "Naglalaro siya sa parke kasama ang kanyang aso."] },
                        task3: { title: "Word Identification (Filipino)", items: ["Aso", "Pusa", "Ibon", "Isda", "Manok", "Baboy", "Kalabaw", "Kambing", "Baka", "Kabayo"], type: "word" },
                        story: { time: 120 }
                    },
                    "bisaya": {
                        task1: { title: "Sentence Recognition (Bisaya)", items: ["Lingin ang bola.", "Nikaon na ka?", "Nidagan ang iro.", "Init ang adlaw.", "Nalipay si Ana.", "Hain ang libro?", "Inom og tubig.", "Abli ang pultahan.", "Kinsa imong kuyog?", "Dako ang balay."], type: "sentence" },
                        task2: { sentences: ["Naay bag-ong bola si Ben.", "Nagdula siya sa parke uban sa iyang iro."] },
                        task3: { title: "Word Identification (Bisaya)", items: ["Iro", "Iring", "Langgam", "Isda", "Manok", "Baboy", "Kabaw", "Kanding", "Baka", "Kabayo"], type: "word" },
                        story: { time: 120 }
                    }
                },
                "3": { // Grade 3
                    "filipino": {
                        task1: { title: "Sentence Recognition (Filipino)", items: ["Nagluto si Nanay ng masarap na adobo.", "Pumunta kami sa dagat noong Linggo.", "Ang mga bata ay nag-aaral ng mabuti.", "Malinis ang aming silid-aralan.", "Si Juan ay mahusay kumanta.", "Nagsisimba kami tuwing Linggo.", "Bumili si Tatay ng bagong sapatos.", "Mabilis tumakbo ang kabayo.", "Mahal ko ang aking pamilya.", "Maganda ang mga bulaklak sa hardin."], type: "sentence" },
                        task2: { sentences: ["Ang pamilya Reyes ay masayang namumuhay sa bukid.", "Tumutulong ang mga anak sa gawaing bahay."] },
                        task3: { title: "Word Identification (Filipino)", items: ["Paaralan", "Simbahan", "Palengke", "Ospital", "Pulisya", "Munisipyo", "Plasa", "Kalsada", "Tulay", "Bukid"], type: "word" },
                        story: { time: 180 }
                    },
                    "bisaya": {
                        task1: { title: "Sentence Recognition (Bisaya)", items: ["Nagluto si Mama og lami nga adobo.", "Niadto mi sa dagat pag-Dominggo.", "Ang mga bata nagtuon og maayo.", "Limpyo ang among classroom.", "Maayo mokanta si Juan.", "Magsimba mi kada Domingo.", "Nipalit si Papa og bag-ong sapatos.", "Kusog modagan ang kabayo.", "Gihigugma nako ang akong pamilya.", "Nindot ang mga bulaklak sa hardin."], type: "sentence" },
                        task2: { sentences: ["Ang pamilya Reyes malipayong nagpuyo sa uma.", "Nagtabang ang mga anak sa buluhaton sa balay."] },
                        task3: { title: "Word Identification (Bisaya)", items: ["Eskwelahan", "Simbahan", "Merkado", "Ospital", "Pulisya", "Munisipyo", "Plasa", "Kalsada", "Tulay", "Uma"], type: "word" },
                        story: { time: 180 }
                    },
                    "english": {
                        task1: { title: "Sentence Recognition (English)", items: ["The sun is shining brightly today.", "We went to the beach last Sunday.", "The children are studying hard.", "Our classroom is clean and tidy.", "Juan sings very well.", "We go to church every Sunday.", "Father bought a new pair of shoes.", "The horse runs very fast.", "I love my family very much.", "The flowers in the garden are beautiful."], type: "sentence" },
                        task2: { sentences: ["The Reyes family lives happily on the farm.", "The children help with the household chores."] },
                        task3: { title: "Word Identification (English)", items: ["School", "Church", "Market", "Hospital", "Station", "Municipal", "Plaza", "Street", "Bridge", "Farm"], type: "word" },
                        story: { time: 180 }
                    }
                }
            };

            // ==========================================
            // TASK 0: ENROLLMENT
            // ==========================================
            function initializeEnrollment() {
                try {
                    const savedLearners = localStorage.getItem('crlaLearners');
                    if (savedLearners) {
                        learners = JSON.parse(savedLearners);
                    }
                    renderLearnersList();
                    updateClassAssessmentDropdown();
                } catch (e) { learners = []; }

                const learnerSelect = document.getElementById('enrolledLearnerSelect');
                if (learnerSelect) learnerSelect.addEventListener('change', (e) => selectLearner(e.target.value));

                const langSelect = document.getElementById('assessmentLanguageSelector');
                if (langSelect) langSelect.addEventListener('change', (e) => loadAssessmentContent(e.target.value));

                const enrollBtn = document.getElementById('enrollLearner');
                if (enrollBtn) enrollBtn.addEventListener('click', enrollNewLearner);

                const updateBtn = document.getElementById('updateLearnerBtn');
                if (updateBtn) updateBtn.addEventListener('click', saveLearnerUpdate);

                const cancelBtn = document.getElementById('cancelEditBtn');
                if (cancelBtn) cancelBtn.addEventListener('click', cancelEdit);

                const editActionBtn = document.getElementById('editLearnerActionBtn');
                if (editActionBtn) editActionBtn.addEventListener('click', editSelectedLearner);

                const clearBtn = document.getElementById('clearForm');
                if (clearBtn) clearBtn.addEventListener('click', clearEnrollmentForm);

                const startBtn = document.getElementById('startAssessment');
                if (startBtn) startBtn.addEventListener('click', () => {
                    const typeSelect = document.getElementById('assessmentTypeSelect');
                    if (typeSelect) {
                        activeAssessmentLabel = typeSelect.value;
                        console.log("Assessment Type Selected:", activeAssessmentLabel);
                    }
                    switchTask('1');
                });

                const removeBtn = document.getElementById('removeLearner');
                if (removeBtn) removeBtn.addEventListener('click', removeSelectedLearner);

                const reportLearnerSelect = document.getElementById('reportLearnerSelect');
                if (reportLearnerSelect) reportLearnerSelect.addEventListener('change', updateAssessmentDropdown);

                const deleteAssessmentBtn = document.getElementById('deleteAssessmentBtn');
                if (deleteAssessmentBtn) deleteAssessmentBtn.addEventListener('click', deleteSelectedAssessment);

                document.getElementById('generateReport').addEventListener('click', generateLearnerReport);
                document.getElementById('editSchoolInfoBtn').addEventListener('click', () => {
                    document.getElementById('modalSchoolName').value = localStorage.getItem('crlaSchoolName') || "";
                    document.getElementById('modalGradeSection').value = localStorage.getItem('crlaGradeSection') || "";
                    document.getElementById('modalTeacherName').value = localStorage.getItem('crlaTeacherName') || "";
                    document.getElementById('schoolDetailsModal').classList.add('active');
                });

                document.getElementById('saveSchoolDetailsBtn').addEventListener('click', () => {
                    const s = document.getElementById('modalSchoolName').value.trim();
                    const g = document.getElementById('modalGradeSection').value.trim();
                    const t = document.getElementById('modalTeacherName').value.trim();
                    const v = document.getElementById('voiceSelector').value;
                    if (s && g && t) {
                        localStorage.setItem('crlaSchoolName', s);
                        localStorage.setItem('crlaGradeSection', g);
                        localStorage.setItem('crlaTeacherName', t);
                        localStorage.setItem('readLens_voiceURI', v);
                        updateHeaderDisplay();
                        document.getElementById('schoolDetailsModal').classList.remove('active');
                        alert("Details saved!");
                    } else alert("Please fill in all fields.");
                });

                updateReportsDropdown();
            }

            function enrollNewLearner() {
                const lrn = document.getElementById('learnerLRN').value.trim();
                const name = document.getElementById('learnerName').value.trim();
                const age = document.getElementById('learnerAge').value;
                const gender = document.getElementById('learnerGender').value;
                const grade = document.getElementById('learnerGrade').value;
                const language = document.getElementById('learnerLanguage').value;
                const notes = document.getElementById('learnerNotes').value.trim();

                if (!name || !age) {
                    alert('Please enter at least name and age');
                    return;
                }

                const newLearner = {
                    id: Date.now().toString(),
                    lrn: lrn || "N/A",
                    name: name,
                    age: parseInt(age),
                    gender: gender,
                    grade: parseInt(grade),
                    language: language,
                    notes: notes,
                    enrollmentDate: new Date().toISOString(),
                    assessments: []
                };

                learners.push(newLearner);
                saveLearners();
                renderLearnersList();
                updateReportsDropdown();
                renderAllLearnersTable();
                updateDashboardDropdown();
                clearEnrollmentForm();
                alert(`Learner ${name} enrolled successfully!`);
            }

            function editSelectedLearner() {
                if (!currentLearnerId) return;
                const l = learners.find(x => x.id === currentLearnerId);
                if (!l) return;
                document.getElementById('learnerLRN').value = l.lrn === "N/A" ? "" : l.lrn;
                document.getElementById('learnerName').value = l.name;
                document.getElementById('learnerAge').value = l.age;
                document.getElementById('learnerGender').value = l.gender;
                document.getElementById('learnerGrade').value = l.grade;
                document.getElementById('learnerLanguage').value = l.language;
                document.getElementById('learnerNotes').value = l.notes;
                document.getElementById('enrollLearner').classList.add('hidden');
                document.getElementById('updateLearnerBtn').classList.remove('hidden');
                document.getElementById('cancelEditBtn').classList.remove('hidden');
            }

            function saveLearnerUpdate() {
                if (!currentLearnerId) return;
                const name = document.getElementById('learnerName').value.trim();
                if (!name) return alert('Name is required.');
                const index = learners.findIndex(x => x.id === currentLearnerId);
                if (index !== -1) {
                    learners[index] = {
                        ...learners[index],
                        lrn: document.getElementById('learnerLRN').value.trim() || "N/A",
                        name: name,
                        age: parseInt(document.getElementById('learnerAge').value),
                        gender: document.getElementById('learnerGender').value,
                        grade: parseInt(document.getElementById('learnerGrade').value),
                        language: document.getElementById('learnerLanguage').value,
                        notes: document.getElementById('learnerNotes').value.trim()
                    };
                    saveLearners();
                    renderLearnersList();
                    updateCurrentLearnerInfo();
                    updateReportsDropdown();
                    renderAllLearnersTable();
                    cancelEdit();
                    alert("Learner details updated!");
                }
            }

            function cancelEdit() {
                clearEnrollmentForm();
                document.getElementById('enrollLearner').classList.remove('hidden');
                document.getElementById('updateLearnerBtn').classList.add('hidden');
                document.getElementById('cancelEditBtn').classList.add('hidden');
            }

            function clearEnrollmentForm() {
                document.getElementById('learnerLRN').value = '';
                document.getElementById('learnerName').value = '';
                document.getElementById('learnerAge').value = '';
                document.getElementById('learnerGender').value = '';
                document.getElementById('learnerNotes').value = '';
            }

            function saveLearners() {
                localStorage.setItem('crlaLearners', JSON.stringify(learners));
            }

            function renderLearnersList() {
                const select = document.getElementById('enrolledLearnerSelect');
                if (learners.length === 0) {
                    if (select) { select.innerHTML = '<option value="">No learners enrolled</option>'; select.disabled = true; }
                    return;
                }
                if (select) {
                    select.disabled = false;
                    select.innerHTML = '<option value="">-- Select a Learner --</option>';
                    const males = learners.filter(l => (l.gender || '').toLowerCase() === 'male').sort((a, b) => a.name.localeCompare(b.name));
                    const females = learners.filter(l => (l.gender || '').toLowerCase() === 'female').sort((a, b) => a.name.localeCompare(b.name));

                    if (males.length) {
                        const grp = document.createElement('optgroup'); grp.label = "MALE";
                        males.forEach(l => { const opt = document.createElement('option'); opt.value = l.id; opt.textContent = `${l.name} (${l.lrn})`; grp.appendChild(opt); });
                        select.appendChild(grp);
                    }
                    if (females.length) {
                        const grp = document.createElement('optgroup'); grp.label = "FEMALE";
                        females.forEach(l => { const opt = document.createElement('option'); opt.value = l.id; opt.textContent = `${l.name} (${l.lrn})`; grp.appendChild(opt); });
                        select.appendChild(grp);
                    }
                    if (currentLearnerId) select.value = currentLearnerId;
                }
                const countDiv = document.getElementById('enrolledLearnerCount');
                if (countDiv) countDiv.textContent = `Total Enrolled: ${learners.length}`;
            }

            function selectLearner(id) {
                currentLearnerId = id || null;
                renderLearnersList();
                updateCurrentLearnerInfo();
                const hasSelection = !!currentLearnerId;
                document.getElementById('startAssessment').disabled = !hasSelection;
                document.getElementById('removeLearner').disabled = !hasSelection;
                document.getElementById('editLearnerActionBtn').disabled = !hasSelection;
                if (hasSelection) {
                    const l = learners.find(x => x.id === id);
                    if (l) setupLanguageSelector(l);
                }
            }

            function removeSelectedLearner() {
                if (!currentLearnerId) return;
                if (confirm("Are you sure you want to delete this learner? All their assessment data will also be removed.")) {
                    const name = learners.find(l => l.id === currentLearnerId)?.name || "Learner";
                    learners = learners.filter(l => l.id !== currentLearnerId);
                    currentLearnerId = null;
                    
                    // Persistence
                    saveLearners();
                    
                    // Comprehensive UI Refresh
                    renderLearnersList();
                    updateCurrentLearnerInfo();
                    renderAllLearnersTable();
                    updateReportsDropdown();
                    updateClassAssessmentDropdown();
                    updateDashboardDropdown();
                    
                    document.getElementById('startAssessment').disabled = true;
                    document.getElementById('removeLearner').disabled = true;
                    document.getElementById('editLearnerActionBtn').disabled = true;
                    
                    alert(`${name} has been removed from the application.`);
                }
            }

            function updateCurrentLearnerInfo() {
                const info = document.getElementById('currentLearnerInfo');
                if (!info) return;
                if (!currentLearnerId) {
                    info.innerHTML = '<p style="color: #6c757d; font-style: italic;">No learner selected</p>';
                    document.getElementById('assessmentLanguageContainer').classList.add('hidden');
                    return;
                }
                const l = learners.find(l => l.id === currentLearnerId);
                info.innerHTML = `<div class="learner-name">${l.name}</div><div class="learner-details">LRN: ${l.lrn} | Age: ${l.age} | Grade: ${l.grade}</div>`;
            }

            // ==========================================
            // DYNAMIC CONTENT LOADING
            // ==========================================
            function setupLanguageSelector(learner) {
                const container = document.getElementById('assessmentLanguageContainer');
                const select = document.getElementById('assessmentLanguageSelector');
                container.classList.add('hidden');

                let options = [];
                if (learner.grade == 1) {
                    activeAssessmentLang = "default";
                    loadAssessmentContent("default");
                    return;
                } else if (learner.grade == 2) {
                    options = [{ val: 'bisaya', label: 'Sinugbuanong Bisaya' }, { val: 'filipino', label: 'Filipino' }];
                } else if (learner.grade == 3) {
                    options = [{ val: 'bisaya', label: 'Sinugbuanong Bisaya' }, { val: 'filipino', label: 'Filipino' }, { val: 'english', label: 'English' }];
                }

                if (options.length > 0) {
                    select.innerHTML = '';
                    options.forEach(opt => {
                        const o = document.createElement('option'); o.value = opt.val; o.textContent = opt.label; select.appendChild(o);
                    });
                    const defaultLang = learner.language ? learner.language.toLowerCase() : '';
                    const match = options.find(o => o.val === defaultLang);
                    activeAssessmentLang = match ? match.val : options[0].val;
                    select.value = activeAssessmentLang;
                    container.classList.remove('hidden');
                    loadAssessmentContent(activeAssessmentLang);
                }
            }

            function loadAssessmentContent(langKey) {
                activeAssessmentLang = langKey;
                const l = learners.find(x => x.id === currentLearnerId);
                if (!l) return;
                const gradeData = assessmentData[l.grade.toString()];
                if (!gradeData) return;
                const content = gradeData[langKey] || gradeData["default"];
                if (!content) return;

                task1WordMiscues = {};

                // UPDATE TASK 1
                document.getElementById('task1Title').textContent = `Task 1: ${content.task1.title}`;

                // Check for user edits before falling back to default
                const userEditedItems = userEdits.task1?.[l.grade]?.[langKey];
                if (userEditedItems) {
                    letters = [...userEditedItems];
                } else {
                    letters = [...content.task1.items];
                }

                letterScores = {};
                totalLetterScore = 0;

                // For Grade 2/3 Task 1 (sentence type), calculate total words
                if (content.task1.type === 'sentence') {
                    // Count total words in all sentences
                    const wordCount = letters.reduce((acc, sent) => acc + sent.split(/\s+/).filter(w => w.trim()).length, 0);
                    totalLetterScore = wordCount; // Initial score is total words (assuming 0 miscues)

                    // Show edit button for sentences, hide add button
                    document.getElementById('toggleTask1Edit').classList.remove('hidden');
                    document.getElementById('addLetter').classList.add('hidden');
                } else {
                    // Hide edit button for letters, show add button
                    document.getElementById('toggleTask1Edit').classList.add('hidden');
                    document.getElementById('addLetter').classList.remove('hidden');
                }

                renderLetterGrid(content.task1.type);

                // UPDATE TASK 2
                const userEditedSentencesT2 = userEdits.task2?.[l.grade]?.[langKey];
                if (userEditedSentencesT2) {
                    sentences = [...userEditedSentencesT2];
                } else {
                    sentences = [...content.task2.sentences];
                }
                sentenceMiscues = [];
                renderSentenceDisplay();

                // UPDATE TASK 3
                document.getElementById('task3Title').textContent = `Task 3: ${content.task3.title}`;
                const instructions = content.task3.type === 'rhyme' ? "Read the pair. Ask if they rhyme." : "Read the word. Ask learner to identify.";
                document.getElementById('task3Instructions').innerHTML = `<strong>Teacher:</strong> ${instructions}`;
                const userEditedRhymes = userEdits.task3?.[l.grade]?.[langKey];
                if (userEditedRhymes) {
                    rhymePairs = userEditedRhymes.map(item => ({ pair: item, isCorrect: null }));
                } else {
                    rhymePairs = content.task3.items.map(item => ({ pair: (item.pair || item), isCorrect: null }));
                }
                renderRhymeList(content.task3.type);

                const timerSelect = document.getElementById('timerDurationSelect');
                if (timerSelect) {
                    timerSelect.value = content.story.time;
                    document.getElementById('timerDisplay').textContent = `${Math.floor(content.story.time / 60).toString().padStart(2, '0')}:00`;
                }

                document.getElementById('row1Label').textContent = content.task1.title;
                document.getElementById('row3Label').textContent = content.task3.title;
                document.getElementById('task1MenuLabel').textContent = content.task1.title.split('(')[0];
                document.getElementById('task3MenuLabel').textContent = content.task3.title.split('(')[0];
            }

            // ==========================================
            // TASK 1: LETTER/WORD NAMING
            // ==========================================
            let letters = [];
            let letterScores = {};
            let totalLetterScore = 0;

            function initializeLetterAssessment() {
                document.getElementById('resetLetters').addEventListener('click', () => {
                    totalLetterScore = 0; letterScores = {}; task1WordMiscues = {};
                    const l = learners.find(x => x.id === currentLearnerId);

                    // Reset score logic for sentence mode
                    if (l && l.grade > 1) {
                        const content = assessmentData[l.grade][activeAssessmentLang];
                        if (content) {
                            // Use original content if possible or current letters
                            // If user edited, we keep edits but reset score
                            const wordCount = letters.reduce((acc, sent) => acc + sent.split(/\s+/).filter(w => w.trim()).length, 0);
                            totalLetterScore = wordCount;
                        }
                    }

                    const type = (l && l.grade > 1) ? 'sentence' : 'letter';
                    renderLetterGrid(type);
                });

                document.getElementById('toggleTask1Edit').addEventListener('click', () => {
                    const area = document.getElementById('task1EditArea');
                    const isHidden = area.style.display === 'none' || area.style.display === '';
                    area.style.display = isHidden ? 'block' : 'none';
                    if (isHidden) document.getElementById('task1Input').value = letters.join('\n');
                });

                document.getElementById('saveTask1Sentences').addEventListener('click', () => {
                    const val = document.getElementById('task1Input').value;
                    const lines = val.split('\n').filter(l => l.trim().length > 0);

                    if (lines.length < 2) {
                        alert("Please enter at least 2 sentences.");
                        return;
                    }

                    letters = lines;

                    // NEW: Save the edit to our cache
                    const learner = learners.find(x => x.id === currentLearnerId);
                    if (learner) {
                        if (!userEdits.task1) userEdits.task1 = {};
                        if (!userEdits.task1[learner.grade]) userEdits.task1[learner.grade] = {};
                        userEdits.task1[learner.grade][activeAssessmentLang] = lines;
                    }
                    localStorage.setItem(USER_EDITS_KEY, JSON.stringify(userEdits));
                    // END NEW

                    task1WordMiscues = {};

                    // Recalculate score
                    const wordCount = letters.reduce((acc, sent) => acc + sent.split(/\s+/).filter(w => w.trim()).length, 0);
                    totalLetterScore = wordCount;

                    renderLetterGrid('sentence');
                    document.getElementById('task1EditArea').style.display = 'none';
                });

                document.getElementById('cancelTask1Edit').addEventListener('click', () => {
                    document.getElementById('task1EditArea').style.display = 'none';
                });

                document.getElementById('addLetter').addEventListener('click', () => {
                    letters.push('?');
                    const l = learners.find(x => x.id === currentLearnerId);
                    const type = (l && l.grade > 1) ? 'sentence' : 'letter';
                    renderLetterGrid(type);
                });

                document.getElementById('playLetters').addEventListener('click', () => speakText(letters.join(', ')));
                document.getElementById('letterSizeSlider').addEventListener('input', (e) => {
                    document.documentElement.style.setProperty('--letter-fs', e.target.value + 'rem');
                });

                document.getElementById('nextTask1').addEventListener('click', () => {
                    if (totalLetterScore <= 6) {
                        alert("Score 6 or below: Proceeding to Task 3 (Remedial Path)");
                        switchTask('3');
                    } else {
                        alert("Score > 6: Proceeding to Task 2 (Advanced Path)");
                        switchTask('2');
                    }
                });
            }

            function renderLetterGrid(type = 'letter') {
                const container = document.getElementById('lettersContainer');
                if (!container) return;
                container.innerHTML = '';

                // Handle Sentence Mode (Grades 2/3) - Single Box Display
                if (type === 'sentence') {
                    // Reset grid style to block for single box
                    container.style.display = 'block';
                    container.style.gridTemplateColumns = 'none';

                    // Re-use style similar to Story Display or Sentence Display
                    const box = document.createElement('div');
                    box.className = 'sentence-display';
                    box.style.textAlign = 'left';
                    box.style.padding = '30px';
                    box.style.lineHeight = '2.2';

                    let globalWordCount = 0;

                    letters.forEach((itemText, idx) => {
                        const p = document.createElement('p');
                        p.style.marginBottom = '15px';

                        const words = itemText.split(/\s+/);
                        words.forEach((w, wi) => {
                            if (!w.trim()) return;
                            const span = document.createElement('span');
                            span.className = 't1-word';
                            span.textContent = w + ' ';
                            span.style.cursor = 'pointer';
                            span.style.padding = '2px 4px';
                            span.style.borderRadius = '4px';
                            span.style.marginRight = '4px';
                            span.style.fontSize = 'var(--letter-fs)';

                            // Check if miscued
                            if (task1WordMiscues[idx] && task1WordMiscues[idx].includes(wi)) {
                                span.classList.add('miscue');
                            }

                            span.addEventListener('click', () => toggleTask1Miscue(idx, wi));
                            p.appendChild(span);
                            globalWordCount++;
                        });
                        box.appendChild(p);
                    });

                    container.appendChild(box);

                    // Update Labels
                    document.getElementById('totalLetters').textContent = globalWordCount;
                    document.getElementById('letterScoreDisplay').textContent = totalLetterScore;
                    return; // EXIT early for sentence mode
                }

                // Default Logic for Grade 1 (Letters) or Word Lists
                container.style.display = 'grid';
                document.getElementById('totalLetters').textContent = letters.length;
                document.getElementById('letterScoreDisplay').textContent = totalLetterScore;

                if (type === 'word') {
                    container.style.gridTemplateColumns = "repeat(3, 1fr)";
                    document.documentElement.style.setProperty('--letter-fs', '2rem');
                } else {
                    container.style.gridTemplateColumns = "repeat(5, 1fr)";
                    document.documentElement.style.setProperty('--letter-fs', '2.5rem');
                }

                letters.forEach((itemText, idx) => {
                    const card = document.createElement('div');
                    card.className = 'letter-card';
                    if (letterScores[idx] === 1) card.classList.add('correct');
                    if (letterScores[idx] === 0) card.classList.add('incorrect');

                    card.innerHTML = `
                        <div class="letter" contenteditable="true">${itemText}</div>
                        <div class="letter-status">
                            <button class="status-btn correct-btn">âœ“</button>
                            <button class="status-btn incorrect-btn">âœ—</button>
                        </div>
                    `;
                    card.querySelector('.letter').addEventListener('blur', (e) => { letters[idx] = e.target.textContent; });
                    card.querySelector('.correct-btn').addEventListener('click', () => markLetter(idx, true, card));
                    card.querySelector('.incorrect-btn').addEventListener('click', () => markLetter(idx, false, card));
                    container.appendChild(card);
                });
            }

            function toggleTask1Miscue(itemIdx, wordIdx) {
                if (!task1WordMiscues[itemIdx]) task1WordMiscues[itemIdx] = [];

                const wList = task1WordMiscues[itemIdx];
                const existingIdx = wList.indexOf(wordIdx);

                // Toggle Logic
                if (existingIdx > -1) {
                    wList.splice(existingIdx, 1);
                    // Removing miscue means +1 to correct words
                    totalLetterScore++;
                } else {
                    wList.push(wordIdx);
                    // Removing playFeedback(false) from Sentence Mode per user request
                    // Adding miscue means -1 to correct words
                    totalLetterScore--;
                }

                if (totalLetterScore < 0) totalLetterScore = 0;

                // Re-render to update classes
                renderLetterGrid('sentence');
            }

            function markLetter(idx, isCorrect, cardElement) {
                const oldScore = letterScores[idx];
                if (isCorrect) {
                    if (oldScore !== 1) totalLetterScore++;
                    playFeedback(true);
                    createConfetti(cardElement);
                } else {
                    if (oldScore === 1) totalLetterScore--;
                    playFeedback(false);
                    showSadFace();
                }
                if (totalLetterScore < 0) totalLetterScore = 0;
                letterScores[idx] = isCorrect ? 1 : 0;
                document.getElementById('letterScoreDisplay').textContent = totalLetterScore;
                cardElement.classList.remove('correct', 'incorrect');
                if (isCorrect) cardElement.classList.add('correct');
                else cardElement.classList.add('incorrect');
            }

            // ==========================================
            // TASK 2: SENTENCE READING
            // ==========================================
            let sentences = [];
            let sentenceMiscues = [];
            let sentenceWords = [];

            function initializeSentenceReading() {
                // Initial render done by loadAssessmentContent
                document.getElementById('toggleSentenceEdit').addEventListener('click', () => {
                    const area = document.getElementById('sentenceEditArea');
                    const isHidden = area.style.display === 'none' || area.style.display === '';
                    area.style.display = isHidden ? 'block' : 'none';
                    if (isHidden) document.getElementById('sentenceInput').value = sentences.join('\n');
                });

                document.getElementById('saveSentences').addEventListener('click', () => {
                    const val = document.getElementById('sentenceInput').value;
                    const lines = val.split('\n').filter(l => l.trim().length > 0);
                    if (lines.length > 0) {
                        sentences = lines;
                        sentenceMiscues = [];
                        const learner = learners.find(x => x.id === currentLearnerId);
                        if (learner) {
                            if (!userEdits.task2) userEdits.task2 = {};
                            if (!userEdits.task2[learner.grade]) userEdits.task2[learner.grade] = {};
                            userEdits.task2[learner.grade][activeAssessmentLang] = lines;
                            localStorage.setItem(USER_EDITS_KEY, JSON.stringify(userEdits));
                        }
                        renderSentenceDisplay();
                        document.getElementById('sentenceEditArea').style.display = 'none';
                    }
                });

                document.getElementById('resetSentences').addEventListener('click', () => {
                    sentenceMiscues = []; renderSentenceDisplay();
                });

                document.getElementById('playSentences').addEventListener('click', () => speakText(sentences.join('. ')));

                document.getElementById('sentenceSizeSlider').addEventListener('input', (e) => {
                    document.documentElement.style.setProperty('--sentence-fs', e.target.value + 'rem');
                });

                document.getElementById('nextTask2').addEventListener('click', () => calculatePart1Profile());
            }

            function renderSentenceDisplay() {
                const container = document.getElementById('sentenceDisplay');
                if (!container) return;
                container.innerHTML = '';
                sentenceWords = [];
                let wordGlobalIdx = 0;

                sentences.forEach(s => {
                    const p = document.createElement('p');
                    s.split(/\s+/).forEach(w => {
                        if (!w.trim()) return;
                        sentenceWords.push(w);
                        const span = document.createElement('span');
                        span.className = 'sentence-word';
                        span.textContent = w + ' ';
                        span.dataset.idx = wordGlobalIdx;
                        if (sentenceMiscues.includes(wordGlobalIdx)) span.classList.add('miscue');
                        span.addEventListener('click', () => toggleSentenceMiscue(parseInt(span.dataset.idx)));
                        p.appendChild(span);
                        wordGlobalIdx++;
                    });
                    container.appendChild(p);
                });
                updateSentenceScore();
            }

            function toggleSentenceMiscue(idx) {
                if (sentenceMiscues.includes(idx)) sentenceMiscues = sentenceMiscues.filter(i => i !== idx);
                else { sentenceMiscues.push(idx); /* playFeedback(false) removed per user request */ }
                renderSentenceDisplay();
            }

            function updateSentenceScore() {
                const total = sentenceWords.length;
                if (total === 0) { document.getElementById('sentenceScoreDisplay').textContent = 0; return; }
                const miscues = sentenceMiscues.length;
                const correct = total - miscues;
                const score = Math.round((correct / total) * 10);
                document.getElementById('sentenceScoreDisplay').textContent = score;
            }

            // ==========================================
            // TASK 3: RHYMING / WORD ID
            // ==========================================
            let rhymePairs = [];

            function initializeRhymeAssessment() {
                // Initial render done by loadAssessmentContent
                document.getElementById('addRhymePair').addEventListener('click', () => {
                    rhymePairs.push({ pair: "New Item", isCorrect: null });
                    const l = learners.find(x => x.id === currentLearnerId);
                    renderRhymeList(l && l.grade > 1 ? 'word' : 'rhyme');
                });

                document.getElementById('resetRhymes').addEventListener('click', () => {
                    rhymePairs.forEach(p => p.isCorrect = null);
                    const l = learners.find(x => x.id === currentLearnerId);
                    renderRhymeList(l && l.grade > 1 ? 'word' : 'rhyme');
                });

                document.getElementById('playRhymes').addEventListener('click', () => {
                    const text = rhymePairs.map(p => p.pair).join('. ');
                    speakText(text);
                });

                document.getElementById('nextTask3').addEventListener('click', () => calculatePart1Profile());
            }

            function renderRhymeList(type = 'rhyme') {
                const container = document.getElementById('rhymePairsContainer');
                if (!container) return;
                container.innerHTML = '';

                if (type === 'word') {
                    // Grade 2/3: Word ID - Box Display (Like Task 1 Grid)
                    container.style.display = 'grid';
                    container.style.gridTemplateColumns = "repeat(3, 1fr)";
                    container.style.gap = "15px";

                    // Calculate Score based on Correct marks (Check = 1 pt)
                    let score = 0;
                    rhymePairs.forEach(p => { if (p.isCorrect === true) score++; });
                    document.getElementById('rhymeScoreDisplay').textContent = score;
                    document.getElementById('totalRhymes').textContent = rhymePairs.length;

                    rhymePairs.forEach((item, idx) => {
                        const card = document.createElement('div');
                        card.className = 'letter-card'; // Reuse existing card style

                        if (item.isCorrect === true) card.classList.add('correct');
                        if (item.isCorrect === false) card.classList.add('incorrect');

                        card.innerHTML = `
                            <div class="letter" contenteditable="true" style="font-size: 2rem;">${item.pair}</div>
                            <div class="letter-status">
                                <button class="status-btn correct-btn">âœ“</button>
                                <button class="status-btn incorrect-btn">âœ—</button>
                            </div>
                         `;

                        // Edit Text Handler with saving
                        card.querySelector('.letter').addEventListener('blur', (e) => {
                            item.pair = e.target.textContent;
                            const learner = learners.find(x => x.id === currentLearnerId);
                            if (learner) {
                                if (!userEdits.task3) userEdits.task3 = {};
                                if (!userEdits.task3[learner.grade]) userEdits.task3[learner.grade] = {};
                                userEdits.task3[learner.grade][activeAssessmentLang] = rhymePairs.map(p => p.pair);
                                localStorage.setItem(USER_EDITS_KEY, JSON.stringify(userEdits));
                            }
                        });

                        // Helper to update visuals without full re-render
                        const updateVisuals = () => {
                            card.classList.remove('correct', 'incorrect');
                            if (item.isCorrect === true) card.classList.add('correct');
                            if (item.isCorrect === false) card.classList.add('incorrect');

                            let newScore = 0;
                            rhymePairs.forEach(p => { if (p.isCorrect === true) newScore++; });
                            document.getElementById('rhymeScoreDisplay').textContent = newScore;
                        };

                        // Scoring Handlers
                        card.querySelector('.correct-btn').addEventListener('click', () => {
                            if (item.isCorrect !== true) {
                                item.isCorrect = true;
                                playFeedback(true);
                                createConfetti(card);
                                updateVisuals();
                            }
                        });

                        card.querySelector('.incorrect-btn').addEventListener('click', () => {
                            if (item.isCorrect !== false) {
                                item.isCorrect = false;
                                playFeedback(false);
                                showSadFace();
                                updateVisuals();
                            }
                        });

                        container.appendChild(card);
                    });
                    return;
                } else {
                    // Grade 1: Rhyme - List (Original Design)
                    container.style.display = 'flex';
                    let score = 0;
                    rhymePairs.forEach((item, idx) => {
                        if (item.isCorrect) score++;
                        const div = document.createElement('div');
                        div.className = 'rhyme-item';
                        div.innerHTML = `
                            <div class="rhyme-text" contenteditable="true">${item.pair}</div>
                            <div class="rhyme-actions">
                                <button class="status-btn correct-btn">âœ“</button>
                                <button class="status-btn incorrect-btn">âœ—</button>
                            </div>
                        `;
                        div.querySelector('.rhyme-text').addEventListener('blur', (e) => {
                            rhymePairs[idx].pair = e.target.textContent;
                            const learner = learners.find(x => x.id === currentLearnerId);
                            if (learner) {
                                if (!userEdits.task3) userEdits.task3 = {};
                                if (!userEdits.task3[learner.grade]) userEdits.task3[learner.grade] = {};
                                userEdits.task3[learner.grade][activeAssessmentLang] = rhymePairs.map(p => p.pair);
                                localStorage.setItem(USER_EDITS_KEY, JSON.stringify(userEdits));
                            }
                        });
                        div.querySelector('.correct-btn').addEventListener('click', () => { item.isCorrect = true; playFeedback(true); renderRhymeList(type); });
                        div.querySelector('.incorrect-btn').addEventListener('click', () => { item.isCorrect = false; playFeedback(false); renderRhymeList(type); });
                        container.appendChild(div);
                    });
                    document.getElementById('rhymeScoreDisplay').textContent = score;
                    document.getElementById('totalRhymes').textContent = rhymePairs.length;
                }
            }

            // ==========================================
            // PART 1 LOGIC & TRANSITION
            // ==========================================
            let part1Profile = "";
            let autoRhymeScore = false;

            function calculatePart1Profile() {
                const sLetter = totalLetterScore; // Task 1 Score

                if (sLetter <= 6) {
                    const sTask3 = parseInt(document.getElementById('rhymeScoreDisplay').textContent);
                    const total = sLetter + sTask3;
                    if (total <= 10) part1Profile = "Full Refresher";
                    else part1Profile = "Moderate Refresher";
                    autoRhymeScore = false;
                } else {
                    autoRhymeScore = true;
                    const sSentence = parseInt(document.getElementById('sentenceScoreDisplay').textContent);
                    const total = sLetter + sSentence + 10; // Auto-credited Task 3 (10pts)
                    if (total >= 27) part1Profile = "Grade Ready";
                    else part1Profile = "Light Refresher";
                }

                document.getElementById('part1ProfileDisplay').textContent = part1Profile;

                if (part1Profile === "Full Refresher" || part1Profile === "Moderate Refresher") {
                    alert(`Part 1 Result: ${part1Profile}.\nAssessment Ends Here. Final Profile: Low Emerging Reader.`);
                    switchTask('5');
                    renderResults(true);
                } else {
                    alert(`Part 1 Result: ${part1Profile}.\nProceeding to Part 2 (Story Reading).`);
                    switchTask('4');
                }
            }

            // ==========================================
            // TASK 4: STORY READING
            // ==========================================
            let storyPassages = [
                {
                    title: "Ang Pagbisita ni Lola Neneng",
                    content: "Si Lola Neneng mianhi sa among balay. Dala-dala niya ang iyang bag nga puno og mga regalo. Nalipay kami nga makakita kaniya. Iyang gikuha ang mga tsokolate ug mga libro gikan sa iyang bag. Among gikuha ang mga regalo ug among gisugdan ang among panihapon.",
                    questions: [{ q: "Unsa ang dala ni Lola Neneng?", a: "bag" }, { q: "Nalipay ba sila?", a: "Oo" }, { q: "Unsa ang sulod?", a: "tsokolate" }, { q: "Unsa gibuhat?", a: "nanihapon" }, { q: "Kinsa mibisita?", a: "Lola Neneng" }]
                }
            ];
            let currentStoryIdx = 0;
            let storyMiscues = [];
            let timerInterval;
            let timeElapsed = 0;
            let isTimerRunning = false;
            let remainingTime = 60;
            let initialDuration = 60;

            function initializeStoryAssessment() {
                // Load user-edited stories if they exist
                if (userEdits.task4 && Array.isArray(userEdits.task4) && userEdits.task4.length > 0) {
                    storyPassages = userEdits.task4;
                }

                renderStorySelect();
                renderStoryDisplay();

                document.getElementById('toggleStoryEdit').addEventListener('click', () => {
                    const area = document.getElementById('storyEditArea');
                    area.style.display = area.style.display === 'none' ? 'block' : 'none';
                    if (area.style.display === 'block') populateStoryEdit();
                });

                document.getElementById('addQuestionInput').addEventListener('click', () => addQuestionInput());
                document.getElementById('saveStoryChanges').addEventListener('click', saveStoryChanges);

                document.getElementById('addStoryBtn').addEventListener('click', () => {
                    storyPassages.push({ title: "New Story", content: "Enter text...", questions: [] });
                    currentStoryIdx = storyPassages.length - 1;
                    renderStorySelect(); renderStoryDisplay(); populateStoryEdit();
                    userEdits.task4 = storyPassages;
                    localStorage.setItem(USER_EDITS_KEY, JSON.stringify(userEdits));
                    document.getElementById('storyEditArea').style.display = 'block';
                });

                document.getElementById('deleteStoryBtn').addEventListener('click', () => {
                    if (storyPassages.length <= 1) {
                        alert("Cannot delete the last story. You must have at least one story.");
                        return;
                    }

                    if (confirm("Are you sure you want to delete this story? This cannot be undone.")) {
                        storyPassages.splice(currentStoryIdx, 1);
                        userEdits.task4 = storyPassages;
                        localStorage.setItem(USER_EDITS_KEY, JSON.stringify(userEdits));

                        // Adjust index if we deleted the last item
                        if (currentStoryIdx >= storyPassages.length) {
                            currentStoryIdx = storyPassages.length - 1;
                        }

                        renderStorySelect();
                        renderStoryDisplay();
                        alert("Story deleted.");
                    }
                });

                document.getElementById('storyPassageSelect').addEventListener('change', (e) => {
                    currentStoryIdx = parseInt(e.target.value); renderStoryDisplay();
                });

                document.getElementById('startTimerBtn').addEventListener('click', toggleTimer);
                document.getElementById('resetTimerBtn').addEventListener('click', resetTimer);
                document.getElementById('timerDurationSelect').addEventListener('change', resetTimer);

                document.getElementById('storySizeSlider').addEventListener('input', (e) => {
                    document.documentElement.style.setProperty('--story-fs', e.target.value + 'rem');
                });

                document.querySelectorAll('.mood-item').forEach(item => {
                    item.addEventListener('click', () => {
                        document.querySelectorAll('.mood-item').forEach(i => i.classList.remove('selected'));
                        item.classList.add('selected');
                    });
                });

                document.querySelectorAll('.observation-option').forEach(item => {
                    item.addEventListener('click', () => {
                        document.querySelectorAll('.observation-option').forEach(i => i.classList.remove('selected'));
                        item.classList.add('selected');
                    });
                });

                document.getElementById('nextTask4').addEventListener('click', () => {
                    renderResults(false);
                    switchTask('5');
                });
            }

            function renderStorySelect() {
                const sel = document.getElementById('storyPassageSelect');
                if (!sel) return;
                sel.innerHTML = '';
                storyPassages.forEach((s, i) => {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.textContent = s.title;
                    sel.appendChild(opt);
                });
                sel.value = currentStoryIdx;
            }

            function renderStoryDisplay() {
                const story = storyPassages[currentStoryIdx];
                const area = document.getElementById('storyDisplayArea');
                if (!area) return;
                area.innerHTML = '';
                storyMiscues = [];
                const words = story.content.split(/\s+/).filter(w => w.trim());
                document.getElementById('totalStoryWords').value = words.length;
                updateStoryMetrics();

                words.forEach((w, i) => {
                    const span = document.createElement('span');
                    span.className = 'story-word';
                    span.textContent = w + ' ';
                    span.dataset.idx = i;
                    span.addEventListener('click', () => {
                        if (storyMiscues.includes(i)) storyMiscues = storyMiscues.filter(x => x !== i);
                        else storyMiscues.push(i);
                        if (storyMiscues.includes(i)) span.classList.add('miscue');
                        else span.classList.remove('miscue');
                        updateStoryMetrics();
                    });
                    area.appendChild(span);
                });

                const qArea = document.getElementById('questionsDisplayArea');
                if (qArea) {
                    qArea.innerHTML = '';
                    story.questions.forEach((q, i) => {
                        const div = document.createElement('div');
                        div.className = 'question-item';
                        div.innerHTML = `
                            <div class="question-text">${q.q}</div>
                            <div class="answer-key">Key: ${q.a}</div>
                            <div class="rhyme-actions">
                                 <button class="status-btn" onclick="markComp(${i}, true, this)">âœ“</button>
                                 <button class="status-btn" onclick="markComp(${i}, false, this)">âœ—</button>
                            </div>
                        `;
                        qArea.appendChild(div);
                    });
                    window.compScores = new Array(story.questions.length).fill(null);
                    updateCompScore();
                }
            }

            window.markComp = function (idx, correct, btn) {
                window.compScores[idx] = correct;
                const parent = btn.parentElement;
                parent.querySelectorAll('.status-btn').forEach(b => {
                    b.classList.remove('correct-btn', 'incorrect-btn');
                    b.style.backgroundColor = ''; b.style.color = '';
                });
                if (correct) {
                    btn.classList.add('correct-btn');
                    playFeedback(true);
                } else {
                    btn.classList.add('incorrect-btn');
                    playFeedback(false);
                }
                updateCompScore();
            }

            function updateCompScore() {
                const s = window.compScores.filter(x => x === true).length;
                document.getElementById('compScoreDisplay').textContent = s;
                document.getElementById('totalQuestionsDisplay').textContent = window.compScores.length;
            }

            function updateStoryMetrics() {
                const total = parseInt(document.getElementById('totalStoryWords').value) || 0;
                const miscues = storyMiscues.length;
                const read = total - miscues;
                document.getElementById('miscuesCount').value = miscues;
                document.getElementById('wordsReadInput').value = read;
            }

            function toggleTimer() {
                const btn = document.getElementById('startTimerBtn');
                if (isTimerRunning) {
                    clearInterval(timerInterval);
                    isTimerRunning = false;
                    btn.textContent = "Start";
                    btn.classList.remove('btn-danger'); btn.classList.add('btn-primary');
                    timeElapsed = initialDuration - remainingTime;
                } else {
                    initialDuration = parseInt(document.getElementById('timerDurationSelect').value);
                    if (remainingTime === 60 && initialDuration !== 60) remainingTime = initialDuration;
                    if (timeElapsed <= 0) remainingTime = initialDuration;

                    isTimerRunning = true;
                    btn.textContent = "Stop / Done";
                    btn.classList.remove('btn-primary'); btn.classList.add('btn-danger');
                    timerInterval = setInterval(() => {
                        remainingTime--;
                        updateTimerDisplay();

                        if (remainingTime === 1) {
                            const sound = document.getElementById('announcementSound');
                            if (sound) {
                                sound.currentTime = 0;
                                sound.play().catch(e => console.log("Audio play failed", e));
                            }
                        }

                        if (remainingTime <= 0) {
                            clearInterval(timerInterval);
                            isTimerRunning = false;
                            btn.textContent = "Start";
                            timeElapsed = initialDuration;
                            alert("Time's Up!");
                        }
                    }, 1000);
                }
            }

            function resetTimer() {
                clearInterval(timerInterval);
                isTimerRunning = false;
                document.getElementById('startTimerBtn').textContent = "Start";
                initialDuration = parseInt(document.getElementById('timerDurationSelect').value);
                remainingTime = initialDuration;
                timeElapsed = 0;
                updateTimerDisplay();
            }

            function updateTimerDisplay() {
                const m = Math.floor(remainingTime / 60);
                const s = remainingTime % 60;
                document.getElementById('timerDisplay').textContent =
                    `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            }

            function populateStoryEdit() {
                const s = storyPassages[currentStoryIdx];
                document.getElementById('editStoryTitle').value = s.title;
                document.getElementById('editStoryContent').value = s.content;
                const qCont = document.getElementById('editQuestionsContainer');
                if (qCont) {
                    qCont.innerHTML = '';
                    s.questions.forEach(q => addQuestionInput(null, q.q, q.a));
                }
            }

            function addQuestionInput(e, qVal = "", aVal = "") {
                const div = document.createElement('div');
                div.className = "form-group p-3 border rounded mb-2 bg-white";
                div.innerHTML = `<input type="text" class="form-input mb-2 q-input" placeholder="Question" value="${qVal}"><input type="text" class="form-input a-input" placeholder="Answer Key" value="${aVal}"><button class="btn btn-sm btn-danger mt-1 remove-q">Remove</button>`;
                div.querySelector('.remove-q').addEventListener('click', () => div.remove());
                document.getElementById('editQuestionsContainer').appendChild(div);
            }

            function saveStoryChanges() {
                const t = document.getElementById('editStoryTitle').value;
                const c = document.getElementById('editStoryContent').value;
                const qs = [];
                document.querySelectorAll('#editQuestionsContainer > div').forEach(d => {
                    const q = d.querySelector('.q-input').value;
                    const a = d.querySelector('.a-input').value;
                    if (q) qs.push({ q, a });
                });
                if (t && c) {
                    storyPassages[currentStoryIdx] = { title: t, content: c, questions: qs };
                    userEdits.task4 = storyPassages;
                    localStorage.setItem(USER_EDITS_KEY, JSON.stringify(userEdits));
                    renderStorySelect(); renderStoryDisplay();
                    document.getElementById('storyEditArea').style.display = 'none';
                }
            }

            // ==========================================
            // RESULTS CALCULATION
            // ==========================================
            function renderResults(isStopped) {
                const wordsRead = parseInt(document.getElementById('wordsReadInput').value) || 0;
                const sec = timeElapsed > 0 ? timeElapsed : 1;
                const wpm = Math.round((wordsRead / sec) * 60);
                const totalWords = parseInt(document.getElementById('totalStoryWords').value) || 1;
                const acc = Math.round((wordsRead / totalWords) * 100);
                const compScore = parseInt(document.getElementById('compScoreDisplay').textContent) || 0;

                let finalProfile = "Low Emerging Reader";
                if (!isStopped) {
                    if (acc <= 25 || (acc <= 50 && compScore === 0)) finalProfile = "High Emerging Reader";
                    else if ((acc > 25 && acc <= 50 && compScore >= 1) || (acc > 50 && acc <= 75 && compScore <= 1)) finalProfile = "Developing Reader";
                    else if ((acc > 50 && acc <= 75 && compScore >= 2) || (acc > 75 && compScore <= 3)) finalProfile = "Transitioning Reader";
                    else if (acc > 75 && compScore >= 4) finalProfile = "Reading At Grade Level";
                }

                document.getElementById('profileResult').textContent = finalProfile;
                document.getElementById('profileDescription').textContent = isStopped ? "Assessment stopped after Part 1." : `Based on WPM: ${wpm}, Accuracy: ${acc}%, and Comprehension: ${compScore}`;

                document.getElementById('score1').textContent = `${totalLetterScore}/10`;
                document.getElementById('score3').textContent = autoRhymeScore ? "10/10 (Auto)" : `${document.getElementById('rhymeScoreDisplay').textContent}/10`;
                document.getElementById('score2').textContent = autoRhymeScore ? `${document.getElementById('sentenceScoreDisplay').textContent}/10` : "N/A";

                if (isStopped) document.querySelectorAll('.part2-row').forEach(r => r.style.display = 'none');
                else {
                    document.querySelectorAll('.part2-row').forEach(r => r.style.display = 'table-row');
                    document.getElementById('scoreTime').textContent = `${sec}s`;
                    document.getElementById('scoreWPM').textContent = wpm;
                    document.getElementById('scoreAccuracy').textContent = `${acc}%`;
                    document.getElementById('scoreComp').textContent = `${compScore}/${document.getElementById('totalQuestionsDisplay').textContent}`;
                }
            }

            document.getElementById('saveResults').addEventListener('click', () => {
                if (!currentLearnerId) return alert("Select learner");
                const l = learners.find(x => x.id === currentLearnerId);
                const missedLetters = letters.filter((_, idx) => letterScores[idx] === 0);
                const miscuedWordsList = sentenceMiscues.map(idx => sentenceWords[idx] || "");

                // Get detailed Task 1 miscues if applicable (Grades 2-3)
                const task1DetailedMiscues = Object.keys(task1WordMiscues).map(idx => {
                    const sentence = letters[idx];
                    const wordIndices = task1WordMiscues[idx];
                    const words = sentence.split(/\s+/);
                    const missed = wordIndices.map(i => words[i]);
                    return { sentence, missedWords: missed };
                }).filter(obj => obj.missedWords.length > 0);

                let p2MiscuedWords = [];
                if (document.getElementById('profileResult').textContent !== "Low Emerging Reader") {
                    const s = storyPassages[currentStoryIdx];
                    if (s) {
                        const words = s.content.split(/\s+/).filter(w => w.trim());
                        p2MiscuedWords = storyMiscues.map(idx => words[idx] || `Word ${idx + 1}`);
                    }
                }
                const rec = {
                    date: new Date().toISOString(),
                    assessmentLabel: activeAssessmentLabel, // NEW: Saved Label
                    part1: {
                        letter: totalLetterScore,
                        sentence: autoRhymeScore ? parseInt(document.getElementById('sentenceScoreDisplay').textContent) : null,
                        rhyme: autoRhymeScore ? 10 : parseInt(document.getElementById('rhymeScoreDisplay').textContent),
                        profile: part1Profile,
                        missedLetters: missedLetters,
                        task1Details: task1DetailedMiscues, // NEW: Detailed Task 1 miscues
                        miscuedWords: miscuedWordsList
                    },
                    part2: document.getElementById('profileResult').textContent === "Low Emerging Reader" ? null : {
                        time: timeElapsed, wordsRead: parseInt(document.getElementById('wordsReadInput').value), totalWords: parseInt(document.getElementById('totalStoryWords').value),
                        wpm: parseInt(document.getElementById('scoreWPM').textContent), accuracy: parseInt(document.getElementById('scoreAccuracy').textContent), comp: parseInt(document.getElementById('compScoreDisplay').textContent),
                        miscues: storyMiscues, miscuedWordsList: p2MiscuedWords,
                        obsLevel: document.querySelector('.observation-option.selected')?.dataset.level || "N/A",
                        mood: document.querySelector('.mood-item.selected')?.dataset.mood || "N/A"
                    },
                    finalProfile: document.getElementById('profileResult').textContent
                };
                l.assessments.push(rec);
                saveLearners();
                renderAllLearnersTable();
                updateReportsDropdown();
                updateClassAssessmentDropdown();
                updateDashboardDropdown();
                alert("Saved!");
            });

            document.getElementById('newAssessment').addEventListener('click', () => {
                totalLetterScore = 0; letterScores = {}; task1WordMiscues = {}; sentenceMiscues = [];
                rhymePairs.forEach(r => r.isCorrect = null); storyMiscues = []; window.compScores = [];
                resetTimer();
                const l = learners.find(x => x.id === currentLearnerId);
                const type1 = (l && l.grade > 1) ? 'sentence' : 'letter';
                renderLetterGrid(type1);
                renderSentenceDisplay();
                const type3 = (l && l.grade > 1) ? 'word' : 'rhyme';
                renderRhymeList(type3);
                renderStoryDisplay();
                switchTask('1');
            });

            // ==========================================
            // REPORTS
            // ==========================================
            function renderAllLearnersTable() {
                const body = document.getElementById('allLearnersBody');
                if (!body) return;
                body.innerHTML = '';
                if (!learners.length) { body.innerHTML = '<tr><td colspan="5">No Data</td></tr>'; return; }
                const sortedLearners = [...learners].sort((a, b) => a.name.localeCompare(b.name));
                sortedLearners.forEach(l => {
                    const last = l.assessments[l.assessments.length - 1];
                    let prof = 'N/A';
                    if (last) prof = last.finalProfile || last.part1?.profile || 'Incomplete';
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${l.name}</td><td>${l.age}</td><td>${l.grade}</td><td>${l.assessments.length}</td><td>${prof}</td>`;
                    body.appendChild(tr);
                });
            }

            function switchReportTab(tab) {
                const individualTab = document.getElementById('tabIndividual');
                const progressTab = document.getElementById('tabProgress');
                const individualCard = document.getElementById('learnerReport');
                const progressCard = document.getElementById('progressReportCard');

                if (!individualTab || !progressTab || !individualCard || !progressCard) {
                    console.error("Report UI elements not found");
                    return;
                }

                if (tab === 'individual') {
                    individualTab.classList.add('active');
                    progressTab.classList.remove('active');
                    individualCard.style.display = 'block';
                    progressCard.style.display = 'none';
                } else {
                    individualTab.classList.remove('active');
                    progressTab.classList.add('active');
                    individualCard.style.display = 'none';
                    progressCard.style.display = 'block';
                }
            }

            // Tab Event Listeners
            const individualTabEl = document.getElementById('tabIndividual');
            const progressTabEl = document.getElementById('tabProgress');
            if (individualTabEl) individualTabEl.addEventListener('click', () => switchReportTab('individual'));
            if (progressTabEl) progressTabEl.addEventListener('click', () => switchReportTab('progress'));

            document.getElementById('showProgressBtn').addEventListener('click', () => {
                const id = document.getElementById('reportLearnerSelect').value;
                if (!id) return alert("Please select a learner first.");
                const l = learners.find(x => x.id === id);
                if (!l) return alert("Learner record not found.");

                showProgressReport(l);
                switchReportTab('progress');
            });

            function generateLearnerReport() {
                try {
                    const id = document.getElementById('reportLearnerSelect').value;
                    if (!id) return alert("Please select a learner first.");
                    const l = learners.find(x => x.id === id);
                    if (!l) return alert("Learner record not found.");
                    let html = `<h4>${l.name}</h4><p>Total Assessments: ${l.assessments.length}</p>`;
                    if (l.assessments.length === 0) html += '<p>No assessment records found.</p>';
                    else {
                        html += `<table class="report-details-table"><thead><tr class="report-details-header"><td>Date</td><td>Part 1</td><td>Part 2</td><td>Final Profile</td></tr></thead><tbody>`;
                        l.assessments.forEach(a => {
                            const date = new Date(a.date).toLocaleDateString();
                            const p1 = a.part1 || {};
                            const p1Desc = `${p1.profile || '-'} (L:${p1.letter ?? '-'}, S:${p1.sentence ?? '-'}, R:${p1.rhyme ?? '-'})`;
                            let p2 = "Skipped";
                            if (a.part2) p2 = `WPM:${a.part2.wpm}, Acc:${a.part2.accuracy}%, Comp:${a.part2.comp}`;
                            const type = a.assessmentLabel ? `<br><small style="color:#666">${a.assessmentLabel}</small>` : '';
                            html += `<tr><td>${date}${type}</td><td>${p1Desc}</td><td>${p2}</td><td><strong>${a.finalProfile || '-'}</strong></td></tr>`;
                        });
                        html += `</tbody></table>`;
                    }
                    document.getElementById('reportContent').innerHTML = html;

                    // Show Progress Report but stay on individual tab if just clicked "View Data"
                    showProgressReport(l);
                    switchReportTab('individual');
                } catch (e) { console.error(e); }
            }

            function showProgressReport(learner) {
                const tbody = document.getElementById('progressReportBody');
                if (!tbody) return;

                if (!learner.assessments || learner.assessments.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No assessment history found.</td></tr>';
                    return;
                }

                tbody.innerHTML = '';

                learner.assessments.forEach((a, index) => {
                    const date = new Date(a.date).toLocaleDateString();
                    const profile = a.finalProfile || (a.part1 ? a.part1.profile : "N/A");

                    let percentage = "N/A";
                    if (a.part2) {
                        const acc = a.part2.accuracy || 0;
                        const comp = ((a.part2.comp || 0) / 5) * 100;
                        percentage = Math.round((acc + comp) / 2) + "%";
                    }

                    const type = a.assessmentLabel ? `<br><small style="color:#666">${a.assessmentLabel}</small>` : '';
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${date}${type}</td>
                        <td>${profile}</td>
                        <td><strong>${percentage}</strong></td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            document.getElementById('exportProgressPDF').addEventListener('click', () => {
                if (!window.jspdf) return alert("PDF library not loaded.");
                const learnerId = document.getElementById('reportLearnerSelect').value;
                if (!learnerId) return alert("Please select a learner first.");
                const l = learners.find(le => le.id === learnerId);
                if (!l || !l.assessments || l.assessments.length === 0) return alert("No assessment data to export.");

                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    const schoolName = localStorage.getItem('crlaSchoolName') || "";
                    const gradeSection = localStorage.getItem('crlaGradeSection') || "";
                    const teacherName = localStorage.getItem('crlaTeacherName') || "";

                    // Header
                    doc.setFontSize(22);
                    doc.setFont("helvetica", "bold");
                    doc.setTextColor(26, 60, 94);
                    doc.text("ReadLens", 105, 20, { align: "center" });

                    doc.setFontSize(16);
                    doc.setFont("helvetica", "normal");
                    doc.text("Student Progress Report", 105, 28, { align: "center" });

                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    doc.text(`School: ${schoolName} | Grade: ${gradeSection} | Teacher: ${teacherName}`, 105, 36, { align: "center" });
                    doc.line(14, 40, 196, 40);

                    // Student Info
                    doc.setFontSize(12);
                    doc.setFont("helvetica", "bold");
                    doc.text("Student Details", 14, 48);
                    doc.autoTable({
                        startY: 52,
                        head: [['Name', 'LRN', 'Gender', 'Age']],
                        body: [[l.name, l.lrn || "N/A", l.gender || "N/A", l.age]],
                        theme: 'grid',
                        headStyles: { fillColor: [26, 60, 94] }
                    });

                    // Progress Table
                    doc.text("Assessment Progress History", 14, doc.lastAutoTable.finalY + 10);
                    const progressData = l.assessments.map((a, i) => {
                        let percentage = "N/A";
                        if (a.part2) {
                            percentage = Math.round((a.part2.accuracy + ((a.part2.comp / 5) * 100)) / 2) + "%";
                        }
                        return [
                            i + 1,
                            new Date(a.date).toLocaleDateString(),
                            a.finalProfile || (a.part1 ? a.part1.profile : "N/A"),
                            percentage
                        ];
                    });

                    doc.autoTable({
                        startY: doc.lastAutoTable.finalY + 15,
                        head: [['#', 'Date', 'Final Profile', 'Average %']],
                        body: progressData,
                        theme: 'striped',
                        headStyles: { fillColor: [52, 152, 219] }
                    });

                    doc.save(`Progress_Report_${l.name.replace(/\s+/g, '_')}.pdf`);
                } catch (e) {
                    console.error("PDF Error", e);
                    alert("Failed to generate PDF.");
                }
            });

            // ==========================================
            // PDF EXPORTS
            // ==========================================
            function updateReportsDropdown() {
                const sel = document.getElementById('reportLearnerSelect');
                const iSel = document.getElementById('interventionLearnerSelect');
                if (!sel || !iSel) return;
                const html = '<option value="">Select a learner</option>';
                sel.innerHTML = html;
                iSel.innerHTML = html;
                if (Array.isArray(learners)) {
                    const sortedLearners = [...learners].sort((a, b) => a.name.localeCompare(b.name));
                    sortedLearners.forEach(l => {
                        const opt = document.createElement('option');
                        opt.value = l.id;
                        opt.textContent = l.name;
                        sel.appendChild(opt.cloneNode(true));
                        iSel.appendChild(opt);
                    });
                }
            }

            function deleteSelectedAssessment() {
                const learnerId = document.getElementById('reportLearnerSelect').value;
                const assessIdx = document.getElementById('assessmentIndexSelect').value;

                if (!learnerId || !assessIdx) {
                    return alert("Please select a learner and a specific assessment to delete.");
                }

                if (confirm("Are you sure you want to permanently delete this assessment record? This action cannot be undone.")) {
                    const learnerIndex = learners.findIndex(l => l.id === learnerId);
                    if (learnerIndex !== -1) {
                        learners[learnerIndex].assessments.splice(assessIdx, 1);
                        saveLearners();

                        // Refresh UI
                        alert("Assessment deleted successfully.");
                        document.getElementById('reportContent').innerHTML = '<p style="color: #6c757d; font-style: italic; text-align: center;">Select a learner and generate a report to view data here.</p>';
                        updateAssessmentDropdown();
                        renderAllLearnersTable();
                        updateClassAssessmentDropdown();
                        updateDashboardDropdown();
                        document.getElementById('deleteAssessmentBtn').disabled = true;
                    }
                }
            }

            function updateAssessmentDropdown() {
                const learnerId = document.getElementById('reportLearnerSelect').value;
                const assessSelect = document.getElementById('assessmentIndexSelect');
                if (!assessSelect) return;
                assessSelect.innerHTML = '<option value="">Select Assessment</option>'; assessSelect.disabled = true;
                if (!learnerId) return;
                const learner = learners.find(l => l.id === learnerId);
                if (learner && learner.assessments && learner.assessments.length > 0) {
                    learner.assessments.forEach((a, index) => {
                        const date = new Date(a.date).toLocaleDateString();
                        const opt = document.createElement('option');
                        const label = a.assessmentLabel ? a.assessmentLabel : `Assessment ${index + 1}`;
                        opt.value = index;
                        opt.textContent = `${label} (${date})`;
                        assessSelect.appendChild(opt);
                    });
                    assessSelect.disabled = false; assessSelect.value = learner.assessments.length - 1;
                }

                // Enable/disable delete button based on selection
                const deleteBtn = document.getElementById('deleteAssessmentBtn');
                if (deleteBtn) deleteBtn.disabled = !assessSelect.value;
            }

            function updateClassAssessmentDropdown() {
                const sel = document.getElementById('classAssessmentPeriod');
                if (!sel) return;
                let max = 0;
                if (learners) learners.forEach(l => { if (l.assessments && l.assessments.length > max) max = l.assessments.length; });
                const current = sel.value;
                let html = '<option value="latest">Latest Assessment</option>';

                // Collect assessment labels for each index
                for (let i = 0; i < max; i++) {
                    // Try to find a label from any learner at this assessment index
                    let label = null;
                    if (learners) {
                        for (let l of learners) {
                            if (l.assessments && l.assessments[i] && l.assessments[i].assessmentLabel) {
                                label = l.assessments[i].assessmentLabel;
                                break;
                            }
                        }
                    }
                    const displayText = label ? label : `Assessment ${i + 1}`;
                    html += `<option value="${i}">${displayText}</option>`;
                }

                sel.innerHTML = html;
                if (current && (current === 'latest' || parseInt(current) < max)) sel.value = current;
            }

            function updateDashboardDropdown() {
                const sel = document.getElementById('dashboardAssessmentPeriod');
                if (!sel) return;
                let max = 0;
                if (learners) learners.forEach(l => { if (l.assessments && l.assessments.length > max) max = l.assessments.length; });
                const current = sel.value;
                let html = '<option value="latest">Latest Assessment</option>';

                // Collect assessment labels for each index
                for (let i = 0; i < max; i++) {
                    // Try to find a label from any learner at this assessment index
                    let label = null;
                    if (learners) {
                        for (let l of learners) {
                            if (l.assessments && l.assessments[i] && l.assessments[i].assessmentLabel) {
                                label = l.assessments[i].assessmentLabel;
                                break;
                            }
                        }
                    }
                    const displayText = label ? label : `Assessment ${i + 1}`;
                    html += `<option value="${i}">${displayText}</option>`;
                }

                sel.innerHTML = html;
                if (current && (current === 'latest' || parseInt(current) < max)) sel.value = current;
            }

            function exportStudentPDF() {
                if (!window.jspdf) return alert("PDF library not loaded. Check internet connection.");

                const learnerId = document.getElementById('reportLearnerSelect').value;
                if (!learnerId) return alert("Please select a learner first.");

                const assessIdx = document.getElementById('assessmentIndexSelect').value;
                if (!assessIdx) return alert("Please select a specific assessment to print.");

                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    const l = learners.find(le => le.id === learnerId);
                    if (!l) return alert("Learner not found.");

                    const a = l.assessments[assessIdx];
                    if (!a) return alert("Assessment data not found.");

                    // Header Info
                    const schoolName = localStorage.getItem('crlaSchoolName') || "";
                    const gradeSection = localStorage.getItem('crlaGradeSection') || "";
                    const teacherName = localStorage.getItem('crlaTeacherName') || "";

                    doc.setFontSize(22);
                    doc.setFont("helvetica", "bold");
                    doc.setTextColor(26, 60, 94);
                    doc.text("ReadLens", 105, 20, { align: "center" });

                    doc.setFontSize(16);
                    doc.setFont("helvetica", "normal");
                    doc.text("Reading Scoresheet", 105, 28, { align: "center" });

                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    doc.text(`School: ${schoolName} | Grade: ${gradeSection} | Teacher: ${teacherName}`, 105, 36, { align: "center" });

                    doc.line(14, 42, 196, 42);

                    doc.setFontSize(12);
                    doc.setFont("helvetica", "bold");
                    doc.text("Student Information", 14, 50);

                    const genderLabel = l.gender ? (l.gender.charAt(0).toUpperCase() + l.gender.slice(1)) : "N/A";

                    doc.autoTable({
                        startY: 55,
                        head: [['Name', 'LRN', 'Age', 'Gender', 'Assessment Date']],
                        body: [[l.name, l.lrn || "N/A", l.age, genderLabel, new Date(a.date).toLocaleDateString()]],
                        theme: 'grid',
                        headStyles: { fillColor: [26, 60, 94], textColor: 255 },
                        styles: { fontSize: 10 }
                    });

                    let yPos = doc.lastAutoTable.finalY + 10;
                    doc.setFontSize(12);
                    doc.text("Part 1: Literacy Assessment", 14, yPos);

                    const p1 = a.part1 || {};
                    const p1Data = [
                        ['Task 1 (Letter/Word)', `${p1.letter ?? "-"} / 10`, p1.letter <= 6 ? "Remedial Path" : "Passed"],
                        ['Task 2 (Sentence)', p1.sentence !== null ? `${p1.sentence} / 10` : "N/A", p1.sentence !== null ? "Completed" : "Skipped"],
                        ['Task 3 (Rhyme/Word ID)', `${p1.rhyme ?? "-"} / 10`, p1.sentence !== null ? "Auto-Credited" : "Assessed"]
                    ];

                    if (p1.task1Details && p1.task1Details.length > 0) {
                        // Format detailed Task 1 miscues
                        const details = p1.task1Details.map(d => `${d.sentence} -> [${d.missedWords.join(', ')}]`).join('\n');
                        p1Data.push(['Missed Words (Task 1)', details, '']);
                    } else if (p1.missedLetters && p1.missedLetters.length > 0) {
                        p1Data.push(['Missed Items (Task 1)', p1.missedLetters.join(', '), '']);
                    }

                    if (p1.miscuedWords && p1.miscuedWords.length > 0) {
                        p1Data.push(['Miscued Words (Task 2)', p1.miscuedWords.join(', '), '']);
                    }

                    doc.autoTable({
                        startY: yPos + 5,
                        head: [['Task', 'Score / Details', 'Status']],
                        body: p1Data,
                        theme: 'grid',
                        headStyles: { fillColor: [26, 60, 94] },
                        foot: [['Part 1 Profile', '', p1.profile || "N/A"]],
                        footStyles: { fillColor: [240, 240, 240], textColor: 0, fontStyle: 'bold' }
                    });

                    yPos = doc.lastAutoTable.finalY + 10;
                    doc.text("Part 2: Fluency & Comprehension", 14, yPos);

                    if (a.part2) {
                        const m = Math.floor(a.part2.time / 60);
                        const s = a.part2.time % 60;
                        const timeStr = `${m}:${s.toString().padStart(2, '0')}`;

                        const p2Body = [
                            ['Words Per Minute (WPM)', a.part2.wpm],
                            ['Reading Accuracy', `${a.part2.accuracy}%`],
                            ['Total Time', `${timeStr} (mm:ss)`],
                            ['Comprehension Score', `${a.part2.comp} / 5`],
                            ['Total Miscues', a.part2.miscues ? a.part2.miscues.length : 0]
                        ];

                        if (a.part2.miscuedWordsList && a.part2.miscuedWordsList.length > 0) {
                            p2Body.push(['Miscued Words (Story)', a.part2.miscuedWordsList.join(', ')]);
                        }

                        doc.autoTable({
                            startY: yPos + 5,
                            head: [['Metric', 'Result']],
                            body: p2Body,
                            theme: 'grid',
                            headStyles: { fillColor: [26, 60, 94] }
                        });

                        yPos = doc.lastAutoTable.finalY + 10;
                        doc.text("Behavioral Observations", 14, yPos);

                        doc.autoTable({
                            startY: yPos + 5,
                            head: [['Observation', 'Rating']],
                            body: [
                                ['Learner Experience (Mood)', `${a.part2.mood} / 5`],
                                ['Reading Fluency Level', `Level ${a.part2.obsLevel}`]
                            ],
                            theme: 'grid',
                            headStyles: { fillColor: [26, 60, 94] }
                        });

                    } else {
                        doc.setFontSize(10);
                        doc.setFont("helvetica", "italic");
                        doc.text("Part 2 was not administered (Low Emerging Reader).", 14, yPos + 10);
                    }

                    yPos = doc.lastAutoTable ? (doc.lastAutoTable.finalY + 20) : (yPos + 20);
                    doc.setDrawColor(26, 60, 94);
                    doc.setLineWidth(1);
                    doc.rect(14, yPos, 182, 25);

                    doc.setFontSize(14);
                    doc.setFont("helvetica", "bold");
                    doc.setTextColor(26, 60, 94);
                    doc.text("FINAL READING PROFILE", 105, yPos + 8, { align: "center" });

                    doc.setFontSize(18);
                    doc.setTextColor(231, 76, 60);
                    doc.text(a.finalProfile || "N/A", 105, yPos + 18, { align: "center" });

                    doc.save(`${l.name}_ScoreSheet.pdf`);
                } catch (e) {
                    console.error(e);
                    alert("Error creating PDF.");
                }
            }

            function exportClassPDF() {
                if (!window.jspdf) return alert("PDF library not loaded.");
                if (learners.length === 0) return alert("No enrolled learners.");

                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('l', 'mm', 'a4');

                    const school = localStorage.getItem('crlaSchoolName') || "";
                    const grade = localStorage.getItem('crlaGradeSection') || "";
                    const teacher = localStorage.getItem('crlaTeacherName') || "";

                    // Period Selection
                    const periodSel = document.getElementById('classAssessmentPeriod');
                    const periodVal = periodSel ? periodSel.value : 'latest';
                    const isLatest = periodVal === 'latest';
                    const periodIdx = isLatest ? -1 : parseInt(periodVal);

                    doc.setFontSize(24);
                    doc.setFont("helvetica", "bold");
                    doc.setTextColor(44, 62, 80);
                    doc.text("ReadLens", 14, 20);

                    doc.setFontSize(14);
                    // Get assessment label if available
                    let periodText = "Latest Assessment";
                    if (!isLatest) {
                        // Try to find a label from any learner at this assessment index
                        let label = null;
                        for (let l of learners) {
                            if (l.assessments && l.assessments[periodIdx] && l.assessments[periodIdx].assessmentLabel) {
                                label = l.assessments[periodIdx].assessmentLabel;
                                break;
                            }
                        }
                        periodText = label ? label : `Assessment ${periodIdx + 1}`;
                    }
                    doc.text(`Reading Scoresheet - ${periodText}`, 14, 28);

                    doc.setFontSize(10);
                    doc.setFont("helvetica", "normal");
                    doc.setTextColor(0, 0, 0);
                    doc.text(`School: ${school}  |  Grade: ${grade}  |  Teacher: ${teacher}`, 14, 36);

                    const tableData = [];
                    const sortedLearners = [...learners].sort((a, b) => {
                        const genderA = (a.gender || '').toLowerCase();
                        const genderB = (b.gender || '').toLowerCase();
                        if (genderA === 'male' && genderB !== 'male') return -1;
                        if (genderA !== 'male' && genderB === 'male') return 1;
                        return a.name.localeCompare(b.name);
                    });

                    sortedLearners.forEach((l, idx) => {
                        let assess;
                        if (isLatest) assess = l.assessments[l.assessments.length - 1];
                        else assess = l.assessments[periodIdx];

                        const date = assess ? new Date(assess.date).toLocaleDateString() : "-";
                        const p1 = assess?.part1 || { letter: 0, rhyme: 0, sentence: 0, profile: '-' };
                        const p2 = assess?.part2 || null;

                        const safeLet = p1.letter ?? 0;
                        const safeRhyme = p1.rhyme ?? 0;
                        const safeSent = p1.sentence ?? 0;
                        const totalP1 = safeLet + safeRhyme + safeSent;

                        let timeStr = "-";
                        if (p2 && p2.time) {
                            const m = Math.floor(p2.time / 60);
                            const s = p2.time % 60;
                            timeStr = `${m}:${s.toString().padStart(2, '0')}`;
                        }

                        // FIX: Use case-insensitive check for gender
                        const genderLower = (l.gender || '').toLowerCase();
                        const sex = genderLower === 'male' ? 'M' : (genderLower === 'female' ? 'F' : '-');

                        tableData.push([
                            idx + 1, l.lrn || "-", l.name, sex, date,
                            p1.letter ?? "-", p1.rhyme ?? "-", p1.sentence !== null ? p1.sentence : "N/A", totalP1, p1.profile || "-",
                            p2 ? "1" : "-", p2 ? (p2.miscues ? p2.miscues.length : 0) : "-", p2 ? p2.wordsRead : "-", timeStr,
                            p2 ? p2.wpm : "-", p2 ? p2.accuracy + "%" : "-", p2 ? p2.comp : "-", p2 ? p2.mood : "-", p2 ? p2.obsLevel : "-",
                            assess ? assess.finalProfile : "-"
                        ]);
                    });

                    doc.autoTable({
                        startY: 45,
                        head: [['No', 'LRN', 'Name', 'Sex', 'Date', 'T1', 'T3', 'T2', 'Tot', 'P1 Lvl', 'Stry', 'Mis', 'Read', 'Time', 'WPM', '%Acc', 'Comp', 'Exp', 'Obs', 'Profile']],
                        body: tableData,
                        theme: 'grid',
                        headStyles: { fillColor: [44, 62, 80], fontSize: 8, halign: 'center' },
                        styles: { fontSize: 8, cellPadding: 2 },
                        columnStyles: { 2: { cellWidth: 25 }, 19: { cellWidth: 25 } }
                    });
                    doc.save(`Scoresheet_${isLatest ? 'Latest' : periodIdx + 1}.pdf`);
                } catch (e) { console.error(e); alert("Error generating PDF."); }
            }

            function exportClassRecordPDF() {
                if (!window.jspdf) return alert("PDF library not loaded.");
                if (learners.length === 0) return alert("No enrolled learners.");

                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('l', 'mm', 'a4');

                    const school = localStorage.getItem('crlaSchoolName') || "";
                    const grade = localStorage.getItem('crlaGradeSection') || "";
                    const teacher = localStorage.getItem('crlaTeacherName') || "";

                    const periodSel = document.getElementById('classAssessmentPeriod');
                    const periodVal = periodSel ? periodSel.value : 'latest';
                    const isLatest = periodVal === 'latest';
                    const periodIdx = isLatest ? -1 : parseInt(periodVal);

                    doc.setFontSize(24);
                    doc.setFont("helvetica", "bold");
                    doc.setTextColor(44, 62, 80);
                    doc.text("ReadLens", 14, 20);

                    doc.setFontSize(14);
                    // Get assessment label if available
                    let periodText = "Latest Assessment";
                    if (!isLatest) {
                        // Try to find a label from any learner at this assessment index
                        let label = null;
                        for (let l of learners) {
                            if (l.assessments && l.assessments[periodIdx] && l.assessments[periodIdx].assessmentLabel) {
                                label = l.assessments[periodIdx].assessmentLabel;
                                break;
                            }
                        }
                        periodText = label ? label : `Assessment ${periodIdx + 1}`;
                    }
                    doc.text(`Class Record - ${periodText}`, 14, 28);

                    doc.setFontSize(10);
                    doc.setFont("helvetica", "normal");
                    doc.setTextColor(0, 0, 0);
                    doc.text(`School: ${school}  |  Grade: ${grade}  |  Teacher: ${teacher}`, 14, 36);

                    const tableData = [];
                    const sortedLearners = [...learners].sort((a, b) => {
                        const genderA = (a.gender || '').toLowerCase();
                        const genderB = (b.gender || '').toLowerCase();
                        if (genderA === 'male' && genderB !== 'male') return -1;
                        if (genderA !== 'male' && genderB === 'male') return 1;
                        return a.name.localeCompare(b.name);
                    });

                    sortedLearners.forEach((l, idx) => {
                        let last;
                        if (isLatest) last = l.assessments[l.assessments.length - 1];
                        else last = l.assessments[periodIdx];

                        // FIX: Use case-insensitive check for gender
                        const genderLower = (l.gender || '').toLowerCase();
                        let sex = genderLower === 'male' ? 'M' : (genderLower === 'female' ? 'F' : '-');

                        let p1Level = "-", pctTotal = "-", fluency = "-", comp = "-", wpm = "-", profile = "-";

                        if (last) {
                            const p1 = last.part1 || {};
                            p1Level = p1.profile || "-";
                            const sL = p1.letter || 0;
                            const sR = p1.rhyme || 0;
                            const isRemedial = p1.sentence === null;
                            const sS = isRemedial ? 0 : p1.sentence;
                            const totalP1 = sL + sR + sS;
                            const maxScore = isRemedial ? 20 : 30;
                            const percentage = Math.round((totalP1 / maxScore) * 100);
                            pctTotal = percentage + "%";
                            const p2 = last.part2;
                            if (p2) {
                                fluency = p2.accuracy + "%";
                                comp = Math.round((p2.comp / 5) * 100) + "%";
                                wpm = p2.wpm;
                            }
                            profile = last.finalProfile || "-";
                        }
                        tableData.push([idx + 1, l.lrn || "-", l.name, sex, p1Level, pctTotal, fluency, comp, wpm, profile]);
                    });

                    doc.autoTable({
                        startY: 45,
                        head: [['No.', 'LRN', 'Name of Learner', 'Sex', 'P1 Level', '% Score', 'Fluency', 'Comp', 'WPM', 'Profile']],
                        body: tableData,
                        theme: 'grid',
                        headStyles: { fillColor: [44, 62, 80], fontSize: 9, halign: 'center', valign: 'middle' },
                        styles: { fontSize: 9, cellPadding: 3, halign: 'center', valign: 'middle' },
                        columnStyles: { 2: { halign: 'left', cellWidth: 40 }, 4: { cellWidth: 30 }, 9: { cellWidth: 35 } }
                    });
                    doc.save(`ClassRecord_${isLatest ? 'Latest' : periodIdx + 1}.pdf`);
                } catch (e) { console.error(e); alert("Error generating Class Record."); }
            }

            function exportClassSummaryPDF() {
                if (!window.jspdf) return alert("PDF library not loaded.");
                if (learners.length === 0) return alert("No enrolled learners.");

                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const school = localStorage.getItem('crlaSchoolName') || "";
                    const grade = localStorage.getItem('crlaGradeSection') || "";
                    const teacher = localStorage.getItem('crlaTeacherName') || "";

                    const periodSel = document.getElementById('classAssessmentPeriod');
                    const periodVal = periodSel ? periodSel.value : 'latest';
                    const isLatest = periodVal === 'latest';
                    const periodIdx = isLatest ? -1 : parseInt(periodVal);

                    doc.setFontSize(22);
                    doc.setFont("helvetica", "bold");
                    doc.setTextColor(26, 60, 94);
                    doc.text("ReadLens", 105, 20, { align: "center" });
                    doc.setFontSize(16);
                    doc.setFont("helvetica", "normal");
                    // Get assessment label if available
                    let periodText = "Latest Assessment";
                    if (!isLatest) {
                        // Try to find a label from any learner at this assessment index
                        let label = null;
                        for (let l of learners) {
                            if (l.assessments && l.assessments[periodIdx] && l.assessments[periodIdx].assessmentLabel) {
                                label = l.assessments[periodIdx].assessmentLabel;
                                break;
                            }
                        }
                        periodText = label ? label : `Assessment ${periodIdx + 1}`;
                    }
                    doc.text(`Class Summary - ${periodText}`, 105, 28, { align: "center" });

                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    doc.text(`School: ${school}`, 14, 40);
                    doc.text(`Grade/Section: ${grade}`, 14, 45);
                    doc.text(`Teacher: ${teacher}`, 14, 50);

                    const stats = {
                        male: { enrolled: 0, assessed: 0, p1: {}, p2: { wpm: 0, acc: 0, comp: 0, count: 0 }, profile: {}, profileNames: {} },
                        female: { enrolled: 0, assessed: 0, p1: {}, p2: { wpm: 0, acc: 0, comp: 0, count: 0 }, profile: {}, profileNames: {} }
                    };
                    const initCounts = (obj) => {
                        obj.p1["Full Refresher"] = 0; obj.p1["Moderate Refresher"] = 0; obj.p1["Light Refresher"] = 0; obj.p1["Grade Ready"] = 0;
                        obj.profile["Low Emerging Reader"] = 0; obj.profile["High Emerging Reader"] = 0;
                        obj.profile["Developing Reader"] = 0; obj.profile["Transitioning Reader"] = 0; obj.profile["Reading At Grade Level"] = 0;

                        obj.profileNames["Low Emerging Reader"] = []; obj.profileNames["High Emerging Reader"] = [];
                        obj.profileNames["Developing Reader"] = []; obj.profileNames["Transitioning Reader"] = []; obj.profileNames["Reading At Grade Level"] = [];
                    };
                    initCounts(stats.male); initCounts(stats.female);

                    learners.forEach(l => {
                        const isMale = (l.gender || '').toLowerCase() === 'male';
                        const target = isMale ? stats.male : stats.female;
                        target.enrolled++;

                        let last;
                        if (isLatest) last = l.assessments[l.assessments.length - 1];
                        else last = l.assessments[periodIdx];

                        if (last) {
                            target.assessed++;
                            const p1Prof = last.part1?.profile;
                            if (p1Prof && target.p1[p1Prof] !== undefined) target.p1[p1Prof]++;
                            if (last.part2) {
                                target.p2.count++; target.p2.wpm += (last.part2.wpm || 0); target.p2.acc += (last.part2.accuracy || 0); target.p2.comp += ((last.part2.comp || 0) / 5) * 100;
                            }
                            const fProf = last.finalProfile;
                            if (fProf && target.profile[fProf] !== undefined) {
                                target.profile[fProf]++;
                                target.profileNames[fProf].push(l.name);
                            }
                        }
                    });

                    // Sort names alphabetically
                    Object.keys(stats.male.profileNames).forEach(k => stats.male.profileNames[k].sort((a, b) => a.localeCompare(b)));
                    Object.keys(stats.female.profileNames).forEach(k => stats.female.profileNames[k].sort((a, b) => a.localeCompare(b)));

                    const getAvg = (sum, count) => count > 0 ? Math.round(sum / count) : 0;
                    const formatNames = (names) => names.length > 0 ? names.map((n, i) => `${i + 1}. ${n}`).join("\n") : "None";

                    const rows = [
                        [{ content: 'Learner Count', colSpan: 4, styles: { fillColor: [240, 240, 240], fontStyle: 'bold' } }],
                        ['Number of Learners Enrolled', stats.male.enrolled, stats.female.enrolled, stats.male.enrolled + stats.female.enrolled],
                        ['Number of Learners Assessed', stats.male.assessed, stats.female.assessed, stats.male.assessed + stats.female.assessed],

                        [{ content: 'Assessment Part 1 Level', colSpan: 4, styles: { fillColor: [240, 240, 240], fontStyle: 'bold' } }],
                        ['Full Refresher', stats.male.p1["Full Refresher"], stats.female.p1["Full Refresher"], stats.male.p1["Full Refresher"] + stats.female.p1["Full Refresher"]],
                        ['Moderate Refresher', stats.male.p1["Moderate Refresher"], stats.female.p1["Moderate Refresher"], stats.male.p1["Moderate Refresher"] + stats.female.p1["Moderate Refresher"]],
                        ['Light Refresher', stats.male.p1["Light Refresher"], stats.female.p1["Light Refresher"], stats.male.p1["Light Refresher"] + stats.female.p1["Light Refresher"]],
                        ['Grade Ready', stats.male.p1["Grade Ready"], stats.female.p1["Grade Ready"], stats.male.p1["Grade Ready"] + stats.female.p1["Grade Ready"]],

                        [{ content: 'Assessment Part 2 Average Score', colSpan: 4, styles: { fillColor: [240, 240, 240], fontStyle: 'bold' } }],
                        ['Reading Fluency (Accuracy %)', getAvg(stats.male.p2.acc, stats.male.p2.count) + '%', getAvg(stats.female.p2.acc, stats.female.p2.count) + '%', getAvg(stats.male.p2.acc + stats.female.p2.acc, stats.male.p2.count + stats.female.p2.count) + '%'],
                        ['Reading Comprehension (%)', getAvg(stats.male.p2.comp, stats.male.p2.count) + '%', getAvg(stats.female.p2.comp, stats.female.p2.count) + '%', getAvg(stats.male.p2.comp + stats.female.p2.comp, stats.male.p2.count + stats.female.p2.count) + '%'],
                        ['Average Word Per Minute', getAvg(stats.male.p2.wpm, stats.male.p2.count), getAvg(stats.female.p2.wpm, stats.female.p2.count), getAvg(stats.male.p2.wpm + stats.female.p2.wpm, stats.male.p2.count + stats.female.p2.count)],

                        [{ content: 'Reading Profile Categories', colSpan: 4, styles: { fillColor: [240, 240, 240], fontStyle: 'bold' } }],

                        ['Low Emerging Reader', stats.male.profile["Low Emerging Reader"], stats.female.profile["Low Emerging Reader"], stats.male.profile["Low Emerging Reader"] + stats.female.profile["Low Emerging Reader"]],
                        [{ content: `M:\n${formatNames(stats.male.profileNames["Low Emerging Reader"])}\n\nF:\n${formatNames(stats.female.profileNames["Low Emerging Reader"])}`, colSpan: 4, styles: { fontSize: 8, textColor: [100, 100, 100], fontStyle: 'italic' } }],

                        ['High Emerging Reader', stats.male.profile["High Emerging Reader"], stats.female.profile["High Emerging Reader"], stats.male.profile["High Emerging Reader"] + stats.female.profile["High Emerging Reader"]],
                        [{ content: `M:\n${formatNames(stats.male.profileNames["High Emerging Reader"])}\n\nF:\n${formatNames(stats.female.profileNames["High Emerging Reader"])}`, colSpan: 4, styles: { fontSize: 8, textColor: [100, 100, 100], fontStyle: 'italic' } }],

                        ['Developing Reader', stats.male.profile["Developing Reader"], stats.female.profile["Developing Reader"], stats.male.profile["Developing Reader"] + stats.female.profile["Developing Reader"]],
                        [{ content: `M:\n${formatNames(stats.male.profileNames["Developing Reader"])}\n\nF:\n${formatNames(stats.female.profileNames["Developing Reader"])}`, colSpan: 4, styles: { fontSize: 8, textColor: [100, 100, 100], fontStyle: 'italic' } }],

                        ['Transitioning Reader', stats.male.profile["Transitioning Reader"], stats.female.profile["Transitioning Reader"], stats.male.profile["Transitioning Reader"] + stats.female.profile["Transitioning Reader"]],
                        [{ content: `M:\n${formatNames(stats.male.profileNames["Transitioning Reader"])}\n\nF:\n${formatNames(stats.female.profileNames["Transitioning Reader"])}`, colSpan: 4, styles: { fontSize: 8, textColor: [100, 100, 100], fontStyle: 'italic' } }],

                        ['Reading At Grade Level', stats.male.profile["Reading At Grade Level"], stats.female.profile["Reading At Grade Level"], stats.male.profile["Reading At Grade Level"] + stats.female.profile["Reading At Grade Level"]],
                        [{ content: `M:\n${formatNames(stats.male.profileNames["Reading At Grade Level"])}\n\nF:\n${formatNames(stats.female.profileNames["Reading At Grade Level"])}`, colSpan: 4, styles: { fontSize: 8, textColor: [100, 100, 100], fontStyle: 'italic' } }]
                    ];

                    doc.autoTable({
                        startY: 65, head: [['Indicator / Category', 'Male', 'Female', 'Total']], body: rows, theme: 'grid',
                        headStyles: { fillColor: [44, 62, 80], halign: 'center' }, styles: { fontSize: 10, cellPadding: 3 },
                        columnStyles: { 0: { cellWidth: 80 }, 1: { halign: 'center' }, 2: { halign: 'center' }, 3: { halign: 'center', fontStyle: 'bold' } }
                    });
                    doc.save(`SummaryReport_${isLatest ? 'Latest' : periodIdx + 1}.pdf`);
                } catch (e) { console.error(e); alert("Error generating Class Summary."); }
            }

            // Re-binding existing listeners for PDF functions
            document.getElementById('exportStudentPDF').addEventListener('click', exportStudentPDF);
            document.getElementById('exportClassPDF').addEventListener('click', exportClassPDF);
            document.getElementById('exportClassRecordPDF').addEventListener('click', exportClassRecordPDF);
            document.getElementById('exportClassSummaryPDF').addEventListener('click', exportClassSummaryPDF);

            // ==========================================
            // INTERVENTIONS LOGIC
            // ==========================================
            document.getElementById('interventionLearnerSelect').addEventListener('change', updateInterventionAssessmentDropdown);
            document.getElementById('interventionIndexSelect').addEventListener('change', () => {
                document.getElementById('generateInterventionBtn').disabled = !document.getElementById('interventionIndexSelect').value;
            });

            function updateInterventionAssessmentDropdown() {
                const learnerId = document.getElementById('interventionLearnerSelect').value;
                const assessSelect = document.getElementById('interventionIndexSelect');
                if (!assessSelect) return;
                assessSelect.innerHTML = '<option value="">Select Assessment</option>';
                assessSelect.disabled = true;
                if (!learnerId) return;
                const learner = learners.find(l => l.id === learnerId);
                if (learner && learner.assessments && learner.assessments.length > 0) {
                    learner.assessments.forEach((a, index) => {
                        const date = new Date(a.date).toLocaleDateString();
                        const opt = document.createElement('option');
                        opt.value = index;
                        opt.textContent = `Assessment ${index + 1} (${date})`;
                        assessSelect.appendChild(opt);
                    });
                    assessSelect.disabled = false;
                    assessSelect.value = learner.assessments.length - 1;
                }
            }

            document.getElementById('generateInterventionBtn').addEventListener('click', () => {
                const learnerId = document.getElementById('interventionLearnerSelect').value;
                const assessIdx = document.getElementById('interventionIndexSelect').value;
                if (!learnerId || assessIdx === "") return alert("Please select learner and assessment.");

                const learner = learners.find(l => l.id === learnerId);
                const assessment = learner.assessments[assessIdx];

                const plan = generateInterventionPlanData(learner, assessment);
                renderInterventionPlan(plan);
                document.getElementById('exportInterventionPDF').disabled = false;
            });

            function generateInterventionPlanData(learner, a) {
                const p1 = a.part1 || {};
                const p2 = a.part2 || {};
                const profile = a.finalProfile;
                const grade = learner.grade;

                // 1. Identify Learner Profile Narrative
                let learnerProfile = "Beginning Reader";
                let narrative = "";

                if (profile.includes("Grade Ready") || profile.includes("Grade Level")) {
                    learnerProfile = "Fluent Reader";
                    narrative = `${learner.name} demonstrates a solid foundation in literacy. They can decode words accurately and read with appropriate speed and expression. The current focus should be on advanced comprehension (inference, evaluation) and expanding vocabulary across different subjects.`;
                } else if (profile.includes("Transitioning") || profile.includes("Developing")) {
                    learnerProfile = "Transitioning Reader";
                    narrative = `${learner.name} is moving into more complex reading tasks. While they have basic decoding skills, they may struggle when encountering multi-syllabic words or longer, more conceptual texts. There is a need to shift from "learning to read" to "reading to learn" by strengthening fluency and vocabulary.`;
                } else {
                    learnerProfile = "Beginning Reader";
                    narrative = `${learner.name} is in the early stages of literacy development. The primary focus for this stage is establishing strong phonemic awareness and sound-letter correspondence. Without these foundational skills, progress in fluency and comprehension will be significantly hindered.`;
                }

                // 2. Granular Data Analysis and Needs Identification
                const needs = [];
                const analysisFlags = {
                    decodingIssue: false,
                    fluencyIssue: false,
                    comprehensionIssue: false,
                    automaticityIssue: false
                };

                if (p1.letter < 8) needs.push("Foundational Phonemic Awareness & Letter Recognition");

                if (p1.sentence !== null && p1.sentence < 6) {
                    needs.push("Basic Word-Level Decoding (CVC & Blending)");
                    analysisFlags.decodingIssue = true;
                }

                if (p2.accuracy !== undefined) {
                    if (p2.accuracy < 90) {
                        needs.push("Accuracy & Word Recognition Strategies");
                        analysisFlags.decodingIssue = true;
                    }

                    if (p2.wpm !== undefined && p2.wpm < 40) {
                        if (p2.accuracy >= 95) {
                            needs.push("Automaticity & Reading Pacing");
                            analysisFlags.automaticityIssue = true;
                        } else {
                            needs.push("Reading Fluency & Phrasing");
                            analysisFlags.fluencyIssue = true;
                        }
                    }
                }

                if (p2.comp !== undefined && p2.comp < 3) {
                    needs.push("Deep Comprehension & Text Engagement");
                    analysisFlags.comprehensionIssue = true;
                }

                // 3. Expert-curated Recommended Plan
                const interventions = [];

                if (needs.some(n => n.includes("Letter Recognition"))) {
                    interventions.push({
                        name: "Multi-Sensory Phoneme-Grapheme Mapping",
                        focus: "Letter-Sound Correspondence (Grade " + grade + ")",
                        materials: "Sand trays, tactile letter cards, magnetic letters, 'Sound Boxes' (Elkonin).",
                        strategies: "Implement 'Say-It-and-Move-It' where students move a token for each sound in a word. Use tactile feedback (tracing letters on rough surfaces) while saying the sound.",
                        steps: "1. Introduce 2-3 sounds per week. 2. Practice matching sounds to symbols. 3. Build simple VC/CVC words immediately using the new sounds.",
                        frequency: "Daily, 15-20 mins",
                        outcomes: "Consistent identification of target phonemes and their associated graphemes with zero hesitation."
                    });
                }

                if (analysisFlags.decodingIssue) {
                    interventions.push({
                        name: "Structured Phonics & Syllable Segmentation",
                        focus: "Decoding Strategies for Unfamiliar Words",
                        materials: "Decodable readers, syllable tiles, word ladders.",
                        strategies: "Teach specific syllable types (Closed, Open, Silent e). Use 'Marking' or 'Scooping' syllables to help break down longer words.",
                        steps: "1. Explicitly teach a phonetic rule. 2. Practice in isolation (word lists). 3. Immediate application in decodable text. 4. Word building with tiles.",
                        frequency: "3-4 times/week, 20 mins",
                        outcomes: "Correctly segment and blend unfamiliar words in a grade-level text with 95% accuracy."
                    });
                }

                if (analysisFlags.fluencyIssue || analysisFlags.automaticityIssue) {
                    const isAuto = analysisFlags.automaticityIssue;
                    interventions.push({
                        name: isAuto ? "Timed Repeated Reading for Speed" : "Repeated Reading for Prosody",
                        focus: isAuto ? "Processing Speed & Pacing" : "Accuracy & Expression",
                        materials: "Tier-2 or Tier-3 fluency passages (at student's instructional level), stopwatch, tracking graph.",
                        strategies: "Use 'Paired Reading' (more able peer or teacher models, then student mimics). Use 'Choral Reading' to build confidence.",
                        steps: "1. Teacher reads while student follows. 2. Student reads same passage 3-4 times. 3. Track time or accuracy on a simple graph to visualize growth.",
                        frequency: "Daily, 15 mins",
                        outcomes: "Increase of 10-15 Words Correct Per Minute (WCPM) over a 2-week period."
                    });
                }

                if (analysisFlags.comprehensionIssue) {
                    interventions.push({
                        name: "Cognitive Strategy Instruction (Meta-Comprehension)",
                        focus: "Inferring and Summarizing Text",
                        materials: "Graphic organizers (Story Maps, Venn Diagrams), Sticky notes for 'Stop and Think'.",
                        strategies: "Implement 'Question-Answer Relationship' (QAR) techniques. Model 'Think-Alouds' where you narrate your mental process while reading.",
                        steps: "1. Pre-reading (Predicting based on title). 2. During reading (Pausing for specific questions). 3. Post-reading (Retelling using 'First, Next, Then, Finally').",
                        frequency: "2-3 times/week, 25 mins",
                        outcomes: "Accurately summarize main ideas and correctly answer 4 out of 5 inferential questions."
                    });
                }

                // Default for advanced students
                if (interventions.length === 0) {
                    interventions.push({
                        name: "Reader's Workshop & Textual Analysis",
                        focus: "Critical Thinking & Vocabulary Expansion",
                        materials: "Novel studies, expository texts, vocabulary journals.",
                        strategies: "Individual research projects based on interest. 'Literature Circles' to discuss character development or author's purpose.",
                        steps: "1. Set a reading goal for the week. 2. Maintain a double-entry journal (quotes and reflections). 3. Conduct weekly peer discussions.",
                        frequency: "Ongoing class integration",
                        outcomes: "Deeper engagement with text and successfully using 5+ new high-tier vocabulary words in writing/speech per week."
                    });
                }

                return {
                    learner: learner.name,
                    date: new Date(a.date).toLocaleDateString(),
                    profile: learnerProfile,
                    narrative: narrative,
                    readingNeeds: needs.length > 0 ? needs : ["Advanced Literacy Development"],
                    plan: interventions,
                    monitoring: [
                        "Weekly 'Cold Read' vs 'Hot Read' WCPM comparison.",
                        "Bi-weekly running records on instructional level text.",
                        "Student self-assessment checklist (Did I pause at periods? Did I use context clues?).",
                        "Pre- and post-intervention assessments using equivalent standardized forms."
                    ]
                };
            }

            function renderInterventionPlan(p) {
                let html = `
                    <div style="background: white; border: 1px solid #e1e4e8; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px;">
                        <div style="display: flex; align-items: flex-start; gap: 15px; margin-bottom: 15px;">
                            <div style="background: var(--primary); color: white; width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                                ðŸ‘¤
                            </div>
                            <div style="flex: 1;">
                                <h4 style="margin: 0; color: var(--secondary); font-size: 1.25rem;">${p.learner}</h4>
                                <p style="margin: 3px 0; color: #586069; font-size: 0.95rem;"><strong>Current Status:</strong> ${p.profile} | <strong>Assessed:</strong> ${p.date}</p>
                            </div>
                        </div>
                        <p style="background: #f1f8ff; padding: 15px; border-radius: 8px; font-size: 1rem; line-height: 1.6; border-left: 4px solid var(--primary); margin: 0;">
                            ${p.narrative}
                        </p>
                    </div>
                `;

                html += `
                    <div style="margin-bottom: 25px; padding-left: 10px;">
                        <h4 style="color: var(--accent); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.3rem;">ðŸŽ¯</span> Identified Reading Needs
                        </h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                            ${p.readingNeeds.map(n => `<span style="background: #fff5f5; color: #c0392b; border: 1px solid #ffc9c9; padding: 6px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: 600;">${n}</span>`).join('')}
                        </div>
                    </div>
                `;

                html += `<h4 style="margin-bottom: 15px; display: flex; align-items: center; gap: 8px; padding-left: 10px;">
                    <span style="font-size: 1.3rem;">ðŸ“‹</span> Recommended Intervention Plan
                </h4>`;

                p.plan.forEach(i => {
                    html += `
                        <div style="background: white; border: 1px solid #eee; border-radius: 12px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.02);">
                            <div style="background: #f8f9fa; padding: 12px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                <h5 style="margin: 0; color: var(--primary); font-size: 1.1rem; font-weight: 700;">${i.name}</h5>
                                <span style="background: #e1f5fe; color: #0288d1; padding: 3px 10px; border-radius: 5px; font-size: 0.8rem; font-weight: bold;">${i.frequency}</span>
                            </div>
                            <div style="padding: 20px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div>
                                        <p style="margin: 0 0 5px 0; font-size: 0.8rem; text-transform: uppercase; color: #6a737d; font-weight: 700;">Focus</p>
                                        <p style="margin: 0; font-size: 0.95rem;">${i.focus}</p>
                                    </div>
                                    <div>
                                        <p style="margin: 0 0 5px 0; font-size: 0.8rem; text-transform: uppercase; color: #6a737d; font-weight: 700;">Materials</p>
                                        <p style="margin: 0; font-size: 0.95rem;">${i.materials || "Standard classroom tools"}</p>
                                    </div>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <p style="margin: 0 0 5px 0; font-size: 0.8rem; text-transform: uppercase; color: #6a737d; font-weight: 700;">Strategies</p>
                                    <p style="margin: 0; font-size: 0.95rem; line-height: 1.5;">${i.strategies}</p>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <p style="margin: 0 0 5px 0; font-size: 0.8rem; text-transform: uppercase; color: #6a737d; font-weight: 700;">Implementation Steps</p>
                                    <p style="margin: 0; font-size: 0.95rem; line-height: 1.5; color: #444;">${i.steps}</p>
                                </div>
                                <div style="background: #f6ffed; border: 1px solid #b7eb8f; padding: 10px 15px; border-radius: 8px; display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 1.1rem;">âœ…</span>
                                    <p style="margin:0; font-size: 0.9rem; color: #389e0d;"><strong>Expected Outcome:</strong> ${i.outcomes}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `
                    <div style="margin-top: 25px; border: 2px dashed #e1e4e8; padding: 20px; border-radius: 12px; background: #fafbfc;">
                        <h4 style="margin: 0 0 12px 0; color: var(--secondary); font-size: 1.1rem;">ðŸ“‰ Suggested Monitoring Indicators</h4>
                        <ul style="padding-left: 20px; margin: 0; font-size: 0.95rem; color: #444;">
                            ${p.monitoring.map(m => `<li style="margin-bottom: 8px;">${m}</li>`).join('')}
                        </ul>
                    </div>
                `;

                document.getElementById('interventionPlanContent').innerHTML = html;
                window.currentInterventionPlan = p; // Store for PDF
            }

            document.getElementById('exportInterventionPDF').addEventListener('click', () => {
                if (!window.currentInterventionPlan) return;
                const p = window.currentInterventionPlan;
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    const school = localStorage.getItem('crlaSchoolName') || "";
                    const teacher = localStorage.getItem('crlaTeacherName') || "";

                    // Header
                    doc.setFillColor(26, 60, 94);
                    doc.rect(0, 0, 210, 40, 'F');
                    doc.setFontSize(24);
                    doc.setFont("helvetica", "bold");
                    doc.setTextColor(255, 255, 255);
                    doc.text("Reading Intervention Plan", 105, 18, { align: "center" });
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "normal");
                    doc.text(`Generated for ${p.learner} via ReadLens`, 105, 28, { align: "center" });
                    doc.setFontSize(9);
                    doc.text(`School: ${school} | Teacher: ${teacher}`, 105, 34, { align: "center" });

                    let y = 50;

                    // Profile Section
                    doc.setTextColor(26, 60, 94);
                    doc.setFontSize(14);
                    doc.setFont("helvetica", "bold");
                    doc.text("Learner Profile Summary", 14, y);
                    y += 6;
                    doc.setFontSize(10);
                    doc.setTextColor(80, 80, 80);
                    doc.text(`Recommended Stage: ${p.profile} | Assessment Date: ${p.date}`, 14, y);
                    y += 8;
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "normal");
                    doc.setTextColor(0, 0, 0);
                    const narrativeLines = doc.splitTextToSize(p.narrative, 180);
                    doc.text(narrativeLines, 14, y);
                    y += (narrativeLines.length * 5) + 8;

                    // Needs
                    doc.setTextColor(231, 76, 60);
                    doc.setFontSize(14);
                    doc.setFont("helvetica", "bold");
                    doc.text("Identified Reading Needs", 14, y);
                    y += 7;
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "normal");
                    doc.setTextColor(0, 0, 0);
                    p.readingNeeds.forEach((n, i) => {
                        doc.text(`â€¢ ${n}`, 18, y);
                        y += 6;
                    });
                    y += 4;

                    // Recommended Interventions
                    doc.setTextColor(26, 60, 94);
                    doc.setFontSize(14);
                    doc.setFont("helvetica", "bold");
                    doc.text("Recommended Interventions & Strategies", 14, y);
                    y += 8;

                    p.plan.forEach(i => {
                        if (y > 240) { doc.addPage(); y = 20; }

                        // Intervention Card-like appearance
                        doc.setFillColor(248, 249, 250);
                        doc.rect(14, y - 5, 182, 45, 'F'); // Approximate height, dynamically adjusted below

                        doc.setFontSize(11);
                        doc.setFont("helvetica", "bold");
                        doc.setTextColor(52, 152, 219);
                        doc.text(i.name, 18, y);

                        doc.setFontSize(8);
                        doc.setTextColor(100, 100, 100);
                        doc.text(i.frequency, 190, y, { align: "right" });

                        y += 6;
                        doc.setFontSize(9);
                        doc.setTextColor(0, 0, 0);
                        doc.setFont("helvetica", "bold");
                        doc.text("Focus:", 18, y);
                        doc.setFont("helvetica", "normal");
                        doc.text(i.focus, 35, y);

                        y += 5;
                        doc.setFont("helvetica", "bold");
                        doc.text("Materials:", 18, y);
                        doc.setFont("helvetica", "normal");
                        doc.text(i.materials || "N/A", 35, y);

                        y += 6;
                        const stratLines = doc.splitTextToSize(`Strategies: ${i.strategies}`, 170);
                        doc.text(stratLines, 18, y);
                        y += (stratLines.length * 5);

                        const stepLines = doc.splitTextToSize(`Steps: ${i.steps}`, 170);
                        doc.text(stepLines, 18, y);
                        y += (stepLines.length * 5);

                        doc.setTextColor(39, 174, 96);
                        doc.setFont("helvetica", "bold");
                        doc.text(`Expected Outcome: ${i.outcomes}`, 18, y);
                        y += 10;
                        doc.setTextColor(0, 0, 0);
                        doc.setFont("helvetica", "normal");
                    });

                    // Monitoring
                    if (y > 230) { doc.addPage(); y = 20; }
                    doc.setTextColor(26, 60, 94);
                    doc.setFontSize(14);
                    doc.setFont("helvetica", "bold");
                    doc.text("Progress Monitoring Indicators", 14, y);
                    y += 8;
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "normal");
                    doc.setTextColor(0, 0, 0);
                    p.monitoring.forEach(m => {
                        doc.text(`â€¢ ${m}`, 18, y);
                        y += 6;
                    });

                    // Footer
                    const pageCount = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);
                        doc.setFontSize(8);
                        doc.setTextColor(150, 150, 150);
                        doc.text(`Page ${i} of ${pageCount} | ReadLens Assessment System`, 105, 290, { align: "center" });
                    }

                    doc.save(`Intervention_Plan_${p.learner.replace(/\s+/g, '_')}.pdf`);
                } catch (e) { console.error(e); alert("PDF Error"); }
            });
            function switchTask(taskId) {
                document.querySelectorAll('.task-item').forEach(i => i.classList.remove('active'));
                document.querySelectorAll('.task-content').forEach(c => c.classList.remove('active'));
                const item = document.querySelector(`.task-item[data-task="${taskId}"]`);
                if (item) item.classList.add('active');
                const content = document.getElementById(`task${taskId}`);
                if (content) content.classList.add('active');
            }

            function speakText(text, lang = 'fil-PH') {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);

                    const voiceURI = localStorage.getItem('readLens_voiceURI');
                    if (voiceURI) {
                        const voice = availableVoices.find(v => v.voiceURI === voiceURI);
                        if (voice) utterance.voice = voice;
                    } else {
                        utterance.lang = lang;
                    }

                    window.speechSynthesis.speak(utterance);
                }
            }

            function createConfetti(el) {
                const confettiContainer = document.createElement('div');
                confettiContainer.className = 'confetti-container';
                const colors = ['#3498db', '#2c3e50', '#e74c3c', '#2ecc71', '#f39c12'];
                for (let i = 0; i < 30; i++) {
                    const c = document.createElement('div'); c.className = 'confetti-piece';
                    c.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    c.style.setProperty('--tx', `${(Math.random() - 0.5) * 100}px`);
                    c.style.setProperty('--ty', `${(Math.random() - 0.5) * 100}px`);
                    c.style.setProperty('--r', `${Math.random() * 360}deg`);
                    confettiContainer.appendChild(c);
                }
                el.appendChild(confettiContainer);
                setTimeout(() => { if (el.contains(confettiContainer)) el.removeChild(confettiContainer); }, 1500);
            }

            function showSadFace() {
                const div = document.createElement('div'); div.className = 'sad-face'; div.textContent = 'ðŸ˜ž';
                document.body.appendChild(div);
                setTimeout(() => { if (div.parentNode) div.parentNode.removeChild(div); }, 2000);
            }

            function updateHeaderDisplay() {
                const s = localStorage.getItem('crlaSchoolName');
                const g = localStorage.getItem('crlaGradeSection');
                const t = localStorage.getItem('crlaTeacherName');
                const div = document.getElementById('headerSchoolInfo');
                if (div) { if (s || g || t) div.innerHTML = `<div class="header-info-line"><strong>${s}</strong></div><div class="header-info-line">${g}</div><div class="header-info-line">${t}</div>`; else div.innerHTML = ""; }
            }

        });
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                        
                        // Check for updates
                        registration.onupdatefound = () => {
                            const installingWorker = registration.installing;
                            installingWorker.onstatechange = () => {
                                if (installingWorker.state === 'installed') {
                                    if (navigator.serviceWorker.controller) {
                                        console.log('New content is available; please refresh.');
                                        if (confirm("A new version of ReadLens is available. Would you like to update now?")) {
                                            window.location.reload();
                                        }
                                    }
                                }
                            };
                        };
                    }, err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
    <!-- Version Update: 2026-02-18 18:40 -->

    <!-- Timer Sound -->
    <audio id="announcementSound" preload="auto">
        <source src="https://orangefreesounds.com/wp-content/uploads/2024/04/Plane-notification-sound.mp3"
            type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

</body>

</html>
